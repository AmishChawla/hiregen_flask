<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
{# jobseeker/_job_cards.html #}
{% for job in jobs %}
<div class="block p-5 rounded-lg border bg-white text-card-foreground shadow-sm hover:shadow-md transition-shadow">
    <div class="flex justify-between items-center">
        <div class="flex items-start space-x-4">
            <img src="{{ job.company_logo }}" alt="{{ job.company_name }} Logo"
                 class="w-12 h-12 min-w-12 rounded-sm object-contain bg-slate-200">
            <div>
                <h2 class="text-lg font-semibold text-slate-900">{{ job.job_title }}</h2>
                <div class="font-medium text-slate-600 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building2 w-4 h-4" data-lov-id="src/components/JobCard.tsx:26:14" data-lov-name="Building2" data-component-path="src/components/JobCard.tsx" data-component-line="26" data-component-file="JobCard.tsx" data-component-name="Building2" data-component-content="%7B%22className%22%3A%22w-4%20h-4%22%7D"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></svg> {{job.company_name}}</div>
                <div class="mt-2 text-slate-500 text-sm flex items-center">
                    <div class="flex items-center gap-2 me-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin w-4 h-4" data-lov-id="src/components/JobCard.tsx:31:16" data-lov-name="MapPin" data-component-path="src/components/JobCard.tsx" data-component-line="31" data-component-file="JobCard.tsx" data-component-name="MapPin" data-component-content="%7B%22className%22%3A%22w-4%20h-4%22%7D"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path><circle cx="12" cy="10" r="3"></circle></svg>{{ job.address_city }}, {{ job.address_province }}, {{ job.address_country }}</div>          
                    <div class="flex items-center gap-2 me-4"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-4 h-4" data-lov-id="src/components/JobCard.tsx:35:16" data-lov-name="Clock" data-component-path="src/components/JobCard.tsx" data-component-line="35" data-component-file="JobCard.tsx" data-component-name="Clock" data-component-content="%7B%22className%22%3A%22w-4%20h-4%22%7D"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>{{ job.opening_date.split('T')[0] }}</div>                                    
                </div>
                <div class="my-3 text-slate-700 text-sm font-medium flex items-center">
                    <div class="bg-slate-100 rounded-xl px-3 py1 me-4">{{ job.job_type }}</div>
                    {% if job.min_salary and job.max_salary %}
                    <div class="bg-white border border-slate-200 rounded-xl px-3">{{ job.salary_currency }}{{ job.min_salary }} - {{ job.salary_currency }}{{ job.max_salary }} {{ job.salary_time_unit }}</div>                    
                    {% elif job.min_salary %}
                    <div class="bg-white border border-slate-200 rounded-xl px-3">{{ job.salary_currency }}{{ job.min_salary }} {{ job.salary_time_unit }}</div>                    
                    {% elif job.max_salary %}
                    <div class="bg-white border border-slate-200 rounded-xl px-3">{{ job.salary_currency }}{{ job.max_salary }} {{ job.salary_time_unit }}</div> 
                    {% elif job.salary %}                   
                    <div class="bg-white border border-slate-200 rounded-xl px-3">{{ job.salary }}</div> 
                    {% else %}
                    <div class="bg-white border border-slate-200 rounded-xl px-3">Not specified</div> 
                    {% endif %}
                    <!--<div class="text-right text-gray-500 text-sm flex items-center gap-2">{{ job.industry }}</div>-->
                </div>
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">{{job.job_description | striptags }}</p>
                
                {% for skill in job.job_skills %}
                <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground text-xs">
                    {{skill}}</div>
                {% endfor %}

            <div class="flex gap-2">
                <a href="{{ url_for('get_post_by_company_subdomain_and_slug', company_subdomain=job.company_subdomain, job_slug=job.job_slug) }}" class="text-white inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary-foreground h-10 px-4 py-2 flex-1 bg-blue-600 hover:bg-blue-700">Apply Now</a>
                <a href="{{ url_for('get_post_by_company_subdomain_and_slug', company_subdomain=job.company_subdomain, job_slug=job.job_slug) }}" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background hover:bg-blue-50 hover:text-accent-foreground h-10 px-4 py-2 flex-1">View Details</a>
            </div>

            </div>
        </div>
        <!-- Save Job Button Top Right -->
        <div>
        {% if job.saved == False %}
            <button class="save-job-btn inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3" title="Save Job" data-job-id="{{ job.id }}" data-user-role="{{ current_user.role if current_user.is_authenticated else 'none' }}" data-is-authenticated="{{ 'true' if current_user.is_authenticated else 'false' }}">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart w-4 h-4">
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
              </svg>
            </button>
        {% else %}
          <button disabled class="inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-red-200 bg-red-50 text-red-600 cursor-not-allowed h-9 rounded-md px-3" title="Saved">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart w-4 h-4 text-red-500">
              <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
            </svg>
          </button>
        {% endif %}
        </div>
        <!-- End Save Job Button -->
    </div>
</div>
{% endfor %}
</div>

<script>
// Define saveJob function globally
function saveJob(jobId, button) {
  console.log('saveJob function called with jobId:', jobId);
  
  // Disable button to prevent multiple clicks
  button.disabled = true;
  button.style.opacity = '0.5';
  
  fetch(`/jobseeker/save-job/${jobId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('Save job response:', data);
    if (data.success) {
      // Update button appearance to show saved state
      button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart w-4 h-4 text-red-500">
        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
      </svg>`;
      button.className = 'inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-red-200 bg-red-50 text-red-600 cursor-not-allowed h-9 rounded-md px-3';
      button.title = 'Saved';
      button.disabled = true;
      button.style.opacity = '1';
      
      // Show success notification if showNotification function exists
      if (typeof showNotification === 'function') {
        showNotification('Job saved successfully!', 'success');
      } else {
        // Simple alert fallback
        alert('Job saved successfully!');
      }
    } else {
      // Show error notification
      if (typeof showNotification === 'function') {
        showNotification(data.message || 'Failed to save job', 'error');
      } else {
        alert(data.message || 'Failed to save job');
      }
      // Re-enable button on error
      button.disabled = false;
      button.style.opacity = '1';
    }
  })
  .catch(error => {
    console.error('Error saving job:', error);
    if (typeof showNotification === 'function') {
      showNotification('Failed to save job. Please try again.', 'error');
    } else {
      alert('Failed to save job. Please try again.');
    }
    // Re-enable button on error
    button.disabled = false;
    button.style.opacity = '1';
  });
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded event fired');
  const saveJobBtns = document.querySelectorAll('.save-job-btn');
  console.log('Found save job buttons:', saveJobBtns.length);
  
  saveJobBtns.forEach((btn, index) => {
    console.log(`Adding event listener to button ${index}`);
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Save job button clicked');
      
      const jobId = this.getAttribute('data-job-id');
      const userRole = this.getAttribute('data-user-role');
      const isAuthenticated = this.getAttribute('data-is-authenticated') === 'true';
      const button = this;
      
      console.log('Job ID:', jobId);
      console.log('User Role:', userRole);
      console.log('Is Authenticated:', isAuthenticated);
      
      // Check if current user is a jobseeker
      if (isAuthenticated && userRole === 'jobseeker') {
        console.log('User is jobseeker, proceeding with save job');
        // User is a jobseeker, proceed with saving job
        saveJob(jobId, button);
      } else {
        console.log('User is not jobseeker, redirecting to login');
        // User is not a jobseeker or not authenticated, redirect to jobseeker login
        window.location.href = "{{ url_for('jobseeker_login') }}";
      }
    });
  });
});
</script>