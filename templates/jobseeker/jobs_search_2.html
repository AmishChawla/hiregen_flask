{% if current_user.role == 'jobseeker' %}
{% extends 'jobseeker/jobseeker_base.html' %}
{% elif current_user.role == 'admin' %}
{% extends 'admin_base.html' %}
{% elif current_user.role == 'user' %}
{% extends 'base.html' %}
{% else %}
{% extends 'common_base.html' %}
{% endif %}


{% block content %}
<div class="">
    <div class="min-h-screen py-0">
      <div class="container max-w-6xl mx-auto px-4 sm:px-6 lg:px-0">
        
    <!--Left Sidebar -->
<div class="">
    
  <div class="grid grid-cols-1 md:grid-cols-12 gap-5">
    <!-- Right Column: Job Listings (8/12) -->
    <div class="md:col-span-12">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2 dark:text-white">Find Your Dream Job</h1>
        <p class="text-gray-600 text-sm">Discover thousands of job opportunities with AI-powered recommendations</p>
    </div>

<!-- Search Jobs -->

 <div class="rounded-lg border bg-white text-card-foreground shadow-sm mb-6">
    <form method="GET" action="{{ url_for('jobs_search') }}">
    <div class="p-6">
        <div class="flex gap-4 flex-wrap">
            <div class="flex-1 min-w-[300px]">
                <div class="relative"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"
                        data-lov-id="src/pages/JobSearch.tsx:182:22" data-lov-name="Search"
                        data-component-path="src/pages/JobSearch.tsx" data-component-line="182"
                        data-component-file="JobSearch.tsx" data-component-name="Search"
                        data-component-content="%7B%22className%22%3A%22absolute%20left-3%20top-1%2F2%20transform%20-translate-y-1%2F2%20text-gray-400%20w-4%20h-4%22%7D">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </svg><input type="text" id="keyword" name="keyword" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm pl-10"
                        placeholder="Job title, keywords, or company" value="{{ prefilled_data.keyword if prefilled_data.keyword is not none else '' }}"></div>
            </div>
            <div class="flex-1 min-w-[200px]">
                <div class="relative"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-map-pin absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"
                        data-lov-id="src/pages/JobSearch.tsx:193:22" data-lov-name="MapPin"
                        data-component-path="src/pages/JobSearch.tsx" data-component-line="193"
                        data-component-file="JobSearch.tsx" data-component-name="MapPin"
                        data-component-content="%7B%22className%22%3A%22absolute%20left-3%20top-1%2F2%20transform%20-translate-y-1%2F2%20text-gray-400%20w-4%20h-4%22%7D">
                        <path
                            d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0">
                        </path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg><input type="text" id="state" name="state" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm pl-10"
                        placeholder="State" value="{{ prefilled_data.state if prefilled_data.state is not none else '' }}"></div>
            </div><button type="submit" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 text-primary-foreground h-10 py-2 bg-blue-600 hover:bg-blue-700 px-8 text-white">Search
                Jobs</button>
        </div>
    </div>
</form>

</div>

<!-- Total jobs found -->
 <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
        <h2 class="text-lg font-semibold text-gray-900">{{total_job_count}} jobs found</h2>
        <div class="flex gap-1">
            <!-- <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-blue-50 text-blue-700 border-blue-200">
                4 Remote</div>
            <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 bg-green-50 text-green-700 border-green-200">
                5 Full-time</div> -->
        </div>
    </div>
    <div class="flex items-center gap-2">
<!--Filters-->
        <form method="GET" action="{{ url_for('jobs_search') }}">
        <div class="flex items-center gap-4 flex-wrap">
            <div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" class="lucide lucide-filter w-4 h-4 text-gray-500"
                    data-lov-id="src/pages/JobSearch.tsx:214:20" data-lov-name="Filter"
                    data-component-path="src/pages/JobSearch.tsx" data-component-line="214"
                    data-component-file="JobSearch.tsx" data-component-name="Filter"
                    data-component-content="%7B%22className%22%3A%22w-4%20h-4%20text-gray-500%22%7D">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg><span class="text-sm font-medium text-gray-700">Filters:</span></div>
                <div>
                    <select name="industry"
                            class="flex h-10 items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 w-[140px]">
                      <option value="">Industries</option>
                      {% for value, label in industries %}
                        <option value="{{ value }}" {% if value == prefilled_data.industry %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                                <div>
                    <select name="job_type"
                            class="flex h-10 items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 w-[140px]">
                      <option value="">Job Types</option>
                      {% for value, label in job_types %}
                        <option value="{{ value }}" {% if value == prefilled_data.job_type %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div>
                    <select name="date_filter"
                            class="flex h-10 items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 w-[140px]">
                      <option value="">Anytime</option>
                      <option value="last_24_hours" {% if prefilled_data.date_filter == 'last_24_hours' %}selected{% endif %}>Last 24 hours</option>
                      <option value="last_week" {% if prefilled_data.date_filter == 'last_week' %}selected{% endif %}>Last Week</option>
                      <option value="last_month" {% if prefilled_data.date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                    </select>
                  </div>
        </div>
        </form>
    </div>
</div>
    </div>
    <!-- Left Column: Filters (4/12) -->
    <div class="md:col-span-12">
    <div>
    <div id="job-results-container" class="container px-4 sm:px-6 lg:px-0">
        
        {% include 'jobseeker/_job_cards.html' %}
    </div>
    <div id="loading-indicator" class="text-center my-4 text-gray-500 hidden">Loading more jobs...</div>
    </div>
    <!--Right Sidebar -->
    </div>
  </div>
</div>

</div>
</div>
</div>
</div>


<script>
let isLoading = false;
let skip = 10; // already loaded initial 10 from server
const limit = 10;
let hasMoreJobs = true; // Track if there are more jobs to load
let scrollTimeout = null;

console.log('Infinite scrolling script initialized');

// Cross-browser compatible scroll detection
function getScrollPosition() {
    // Cross-browser scroll position
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    const windowHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight || 0;
    const documentHeight = Math.max(
        document.body.scrollHeight || 0,
        document.body.offsetHeight || 0,
        document.documentElement.clientHeight || 0,
        document.documentElement.scrollHeight || 0,
        document.documentElement.offsetHeight || 0
    );
    
    return {
        scrollTop: scrollTop,
        windowHeight: windowHeight,
        documentHeight: documentHeight,
        distanceFromBottom: documentHeight - (windowHeight + scrollTop)
    };
}

// Throttled scroll handler for better performance
function handleScroll() {
    if (scrollTimeout) {
        clearTimeout(scrollTimeout);
    }
    
    scrollTimeout = setTimeout(async () => {
        const scrollInfo = getScrollPosition();
        
        console.log('Infinite scroll check - scrollTop:', scrollInfo.scrollTop, 'windowHeight:', scrollInfo.windowHeight, 'documentHeight:', scrollInfo.documentHeight);
        console.log('Distance from bottom:', scrollInfo.distanceFromBottom);
        
        // Check if we're near the bottom and not already loading
        // Use a more generous threshold for better cross-browser compatibility
        if (
            scrollInfo.distanceFromBottom <= 300 &&
            !isLoading &&
            hasMoreJobs
        ) {
            console.log('Scroll detected - near bottom, triggering loadMoreJobs');
            await loadMoreJobs();
        } else {
            console.log('Scroll detected but conditions not met - isLoading:', isLoading, 'hasMoreJobs:', hasMoreJobs, 'distance from bottom:', scrollInfo.distanceFromBottom);
        }
    }, 100); // Throttle to 100ms
}

// Cross-browser scroll event listener
if (window.addEventListener) {
    window.addEventListener('scroll', handleScroll, { passive: true });
    // Also listen for resize events in case window size changes
    window.addEventListener('resize', handleScroll, { passive: true });
} else if (window.attachEvent) {
    // Fallback for older IE
    window.attachEvent('onscroll', handleScroll);
    window.attachEvent('onresize', handleScroll);
}

// Additional fallback: Check on page load and after a delay
document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to load more jobs immediately (in case page is short)
    setTimeout(() => {
        const scrollInfo = getScrollPosition();
        if (scrollInfo.distanceFromBottom <= 300 && !isLoading && hasMoreJobs) {
            console.log('Page loaded - checking if we need to load more jobs immediately');
            loadMoreJobs();
        }
    }, 1000);
});

async function loadMoreJobs() {
    console.log('loadMoreJobs called - isLoading:', isLoading, 'hasMoreJobs:', hasMoreJobs);
    
    if (isLoading || !hasMoreJobs) {
        console.log('loadMoreJobs blocked - isLoading:', isLoading, 'hasMoreJobs:', hasMoreJobs);
        return;
    }
    
    isLoading = true;
    console.log('Starting to load more jobs - skip:', skip, 'limit:', limit);
    
    // Show loading indicator
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.classList.remove('hidden');
    console.log('Loading indicator shown');
    
    try {
        const baseUrl = new URL(window.location.href);
        const params = new URLSearchParams(baseUrl.search);

        // Append pagination parameters
        params.set('skip', skip);
        params.set('limit', limit);

        const url = `${baseUrl.pathname}?${params.toString()}`;
        console.log('Making AJAX request to:', url);

        // Cross-browser compatible fetch with fallback
        let response;
        try {
            response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                    'Cache-Control': 'no-cache'
                },
                credentials: 'same-origin'
            });
        } catch (fetchError) {
            console.error('Fetch failed, trying XMLHttpRequest fallback:', fetchError);
            // Fallback to XMLHttpRequest for older browsers
            response = await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.setRequestHeader('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve({
                                ok: true,
                                status: xhr.status,
                                text: () => Promise.resolve(xhr.responseText)
                            });
                        } else {
                            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                        }
                    }
                };
                
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send();
            });
        }

        console.log('Response received - status:', response.status, 'ok:', response.ok);

        if (response.ok) {
            const html = await response.text();
            console.log('HTML response length:', html.length);
            console.log('HTML response preview:', html.substring(0, 200) + '...');

            if (!html.trim()) {
                console.log('Empty HTML response - no more jobs to load');
                hasMoreJobs = false;
                loadingIndicator.textContent = 'No more jobs to load';
                return;
            }

            // Check if the response contains job cards
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const jobCards = tempDiv.querySelectorAll('.block.p-5.rounded-lg');
            console.log('Job cards found in response:', jobCards.length);
            
            if (jobCards.length === 0) {
                console.log('No job cards found in response - stopping infinite scroll');
                hasMoreJobs = false;
                loadingIndicator.textContent = 'No more jobs to load';
                return;
            }
            
            // Insert the new job cards
            const jobContainer = document.getElementById('job-results-container');
            console.log('Inserting', jobCards.length, 'job cards into container');
            jobContainer.insertAdjacentHTML('beforeend', html);
            
            skip += limit;
            console.log('Updated skip to:', skip);
            
            // If we received fewer jobs than requested, we've reached the end
            if (jobCards.length < limit) {
                console.log('Received fewer jobs than requested - reached end of results');
                hasMoreJobs = false;
                loadingIndicator.textContent = 'No more jobs to load';
            }
        } else {
            console.error('Failed to fetch jobs - status:', response.status);
            loadingIndicator.textContent = 'Error loading jobs. Please try again.';
        }
    } catch (error) {
        console.error('Error fetching jobs:', error);
        loadingIndicator.textContent = 'Error loading jobs. Please try again.';
    } finally {
        isLoading = false;
        console.log('Request completed - isLoading set to false');
        
        // Hide loading indicator after a delay if there are no more jobs
        if (!hasMoreJobs) {
            console.log('No more jobs - hiding loading indicator after delay');
            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                console.log('Loading indicator hidden');
            }, 2000);
        } else {
            loadingIndicator.classList.add('hidden');
            console.log('Loading indicator hidden immediately');
        }
    }
}

// Reset pagination when search form is submitted
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - setting up event listeners');
    
    const searchForm = document.querySelector('form[method="GET"]');
    if (searchForm) {
        console.log('Search form found - adding submit listener');
        searchForm.addEventListener('submit', function() {
            console.log('Search form submitted - resetting pagination');
            skip = 10;
            hasMoreJobs = true;
            isLoading = false;
        });
    } else {
        console.log('Search form not found');
    }
    
    // Also reset when filter dropdowns change
    const filterSelects = document.querySelectorAll('select[name="industry"], select[name="job_type"], select[name="date_filter"]');
    console.log('Filter selects found:', filterSelects.length);
    filterSelects.forEach((select, index) => {
        console.log('Adding change listener to filter select', index);
        select.addEventListener('change', function() {
            console.log('Filter changed - submitting form');
            skip = 10;
            hasMoreJobs = true;
            isLoading = false;
            
            // Submit the search form
            const searchForm = document.querySelector('form[method="GET"]');
            if (searchForm) {
                console.log('Submitting search form due to filter change');
                searchForm.submit();
            } else {
                console.log('Search form not found for submission');
            }
        });
    });
});
</script>

<!-- Filter Auto-Submit Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Filter auto-submit script initialized');
    
    // Get all filter dropdowns
    const filterSelects = document.querySelectorAll('select[name="industry"], select[name="job_type"], select[name="date_filter"]');
    console.log('Filter selects found for auto-submit:', filterSelects.length);
    
    // Add change listeners to each filter
    filterSelects.forEach((select, index) => {
        console.log('Adding auto-submit listener to filter select', index, 'name:', select.name);
        select.addEventListener('change', function() {
            console.log('Filter changed - auto-submitting form:', select.name, 'value:', select.value);
            
            // Get the search form
            const searchForm = document.querySelector('form[method="GET"]');
            if (searchForm) {
                // Ensure all current filter values are included
                const currentParams = new URLSearchParams(window.location.search);
                
                // Update the changed filter value
                if (select.value) {
                    currentParams.set(select.name, select.value);
                } else {
                    currentParams.delete(select.name);
                }
                
                // Preserve other form inputs (keyword, state, etc.)
                const keywordInput = searchForm.querySelector('input[name="keyword"]');
                const stateInput = searchForm.querySelector('input[name="state"]');
                
                if (keywordInput && keywordInput.value) {
                    currentParams.set('keyword', keywordInput.value);
                }
                if (stateInput && stateInput.value) {
                    currentParams.set('state', stateInput.value);
                }
                
                console.log('Auto-submitting with params:', currentParams.toString());
                
                // Create new URL with all parameters
                const newUrl = window.location.pathname + '?' + currentParams.toString();
                window.location.href = newUrl;
            } else {
                console.log('Search form not found for auto-submission');
            }
        });
    });
});
</script>
    
{% endblock %}
