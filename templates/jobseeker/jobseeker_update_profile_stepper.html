{% extends 'jobseeker/jobseeker_base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto py-10">
  <h1 class="text-2xl font-semibold text-gray-900">Update Your Profile</h1>

  <!-- Progress Bar -->
  <nav aria-label="Progress">
    <ol
      role="list"
      id="progressBar"
      class="divide-y divide-gray-300 rounded-md border border-gray-300 md:flex md:divide-y-0"
    >
      <!-- Step 1: About -->
      <li class="relative md:flex md:flex-1 step" data-step="1">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">1</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              About
            </span>
          </span>
        </a>
        <!-- Arrow separator (desktop) -->
        <div
          class="absolute right-0 top-0 hidden h-full w-5 md:block"
          aria-hidden="true"
        >
          <svg
            class="size-full text-gray-300"
            viewBox="0 0 22 80"
            fill="none"
            preserveAspectRatio="none"
          >
            <path
              d="M0 -2L20 40L0 82"
              vector-effect="non-scaling-stroke"
              stroke="currentcolor"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </li>

      <!-- Step 2: Education -->
      <li class="relative md:flex md:flex-1 step" data-step="2">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">2</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              Education
            </span>
          </span>
        </a>
        <div
          class="absolute right-0 top-0 hidden h-full w-5 md:block"
          aria-hidden="true"
        >
          <svg
            class="size-full text-gray-300"
            viewBox="0 0 22 80"
            fill="none"
            preserveAspectRatio="none"
          >
            <path
              d="M0 -2L20 40L0 82"
              vector-effect="non-scaling-stroke"
              stroke="currentcolor"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </li>

      <!-- Step 3: Experience -->
      <li class="relative md:flex md:flex-1 step" data-step="3">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">3</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              Experience
            </span>
          </span>
        </a>
        <div
          class="absolute right-0 top-0 hidden h-full w-5 md:block"
          aria-hidden="true"
        >
          <svg
            class="size-full text-gray-300"
            viewBox="0 0 22 80"
            fill="none"
            preserveAspectRatio="none"
          >
            <path
              d="M0 -2L20 40L0 82"
              vector-effect="non-scaling-stroke"
              stroke="currentcolor"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </li>

      <!-- Step 4: Internships -->
      <li class="relative md:flex md:flex-1 step" data-step="4">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">4</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              Internships
            </span>
          </span>
        </a>
        <div
          class="absolute right-0 top-0 hidden h-full w-5 md:block"
          aria-hidden="true"
        >
          <svg
            class="size-full text-gray-300"
            viewBox="0 0 22 80"
            fill="none"
            preserveAspectRatio="none"
          >
            <path
              d="M0 -2L20 40L0 82"
              vector-effect="non-scaling-stroke"
              stroke="currentcolor"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </li>

      <!-- Step 5: Projects -->
      <li class="relative md:flex md:flex-1 step" data-step="5">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">5</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              Projects
            </span>
          </span>
        </a>
        <div
          class="absolute right-0 top-0 hidden h-full w-5 md:block"
          aria-hidden="true"
        >
          <svg
            class="size-full text-gray-300"
            viewBox="0 0 22 80"
            fill="none"
            preserveAspectRatio="none"
          >
            <path
              d="M0 -2L20 40L0 82"
              vector-effect="non-scaling-stroke"
              stroke="currentcolor"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </li>

      <!-- Step 6: Accomplishments -->
      <li class="relative md:flex md:flex-1 step" data-step="6">
        <a href="#" class="group flex w-full items-center">
          <span class="flex items-center px-6 py-4 text-sm font-medium">
            <span
              class="flex size-10 shrink-0 items-center justify-center rounded-full border-2 border-gray-300"
            >
              <span class="text-gray-500">6</span>
            </span>
            <span class="ml-4 text-sm font-medium text-gray-500 group-hover:text-gray-900">
              Accomplishments
            </span>
          </span>
        </a>
      </li>
    </ol>
  </nav>


  <!-- Step Forms -->
<form id="jobseeker-form" method="POST" action="{{url_for('jobseeker_update_profile')}}" novalidate class="space-y-12">
  <!-- Step 1: About -->
  <div class="step-content" id="step-1">
    <div class="border-b border-gray-900/10 pb-12">
      <h2 class="text-base font-semibold text-gray-900">About</h2>
      <p class="mt-1 text-sm text-gray-600">Write a brief introduction about yourself.</p>

      <div class="mt-10 mb-2">
        {{ about_form.hidden_tag() }}
        <label for="about" class="block text-sm font-medium text-gray-900">About</label>
        {{ about_form.about(class_="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600") }}
        <p class="mt-3 text-sm text-gray-600">This information will be displayed publicly.</p>
      </div>
    </div>
    <div class="mt-6 flex justify-end">
      <button type="button" class="next bg-indigo-600 text-white px-4 py-2 rounded-md">Next</button>
    </div>
  </div>

<!-- Step 2: Education -->
<div class="step-content hidden" id="step-2">
  <div class="border-b border-gray-900/10 pb-12">
    <h2 class="text-base font-semibold text-gray-900">Education</h2>
    <p class="mt-1 text-sm text-gray-600">List your educational background.</p>

    <div id="education-container" class="mt-10">
      <div class="entry-form card p-6 shadow border border-gray-200 rounded-md mb-4">
        {{ education_form.hidden_tag() }}

        <label for="institution_name" class="block m-2 text-sm font-medium text-gray-900">Institution Name</label>
        {{ education_form.institution_name(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="degree" class="block m-2 text-sm font-medium text-gray-900">Degree</label>
        {{ education_form.degree(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="field_of_study" class="block m-2 text-sm font-medium text-gray-900">Field of Study</label>
        {{ education_form.field_of_study(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="start_date" class="block m-2 text-sm font-medium text-gray-900">Start Date</label>
        {{ education_form.start_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="end_date" class="block m-2 text-sm font-medium text-gray-900">End Date</label>
        {{ education_form.end_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label class="flex items-center gap-2">
          {{ education_form.ongoing }}
          <span class="text-sm text-gray-900">Currently studying here</span>
        </label>
      </div>
    </div>

    <button type="button" id="add-education" class="mt-4 text-indigo-600">Add More</button>
  </div>

  <div class="mt-6 flex justify-between">
    <button type="button" class="prev rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"">Previous</button>
    <button type="button" class="next bg-indigo-600 text-white px-4 py-2 rounded-md">Next</button>
  </div>
</div>

<!-- Step 3: Experience -->
<div class="step-content hidden" id="step-3">
  <div class="border-b border-gray-900/10 pb-12">
    <h2 class="text-base font-semibold text-gray-900">Experience</h2>
    <p class="mt-1 text-sm text-gray-600">List your work experience.</p>

    <div id="experience-container" class="mt-10">
      <div class="entry-form card p-6 shadow border border-gray-200 rounded-md mb-4">
        {{ experience_form.hidden_tag() }}

        <label for="company_name" class="block m-2 text-sm font-medium text-gray-900">Company Name</label>
        {{ experience_form.company_name(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="position" class="block m-2 text-sm font-medium text-gray-900">Position</label>
        {{ experience_form.position(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="start_date" class="block m-2 text-sm font-medium text-gray-900">Start Date</label>
        {{ experience_form.start_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="end_date" class="block m-2 text-sm font-medium text-gray-900">End Date</label>
        {{ experience_form.end_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label class="flex items-center gap-2">
          {{ experience_form.ongoing }}
          <span class="text-sm text-gray-900">Currently working here</span>
        </label>

        <label for="responsibilities" class="block m-2 text-sm font-medium text-gray-900">Responsibilities</label>
        {{ experience_form.responsibilities(class_="block w-full rounded-md bg-white px-3 py-1.5") }}
      </div>
    </div>

    <button type="button" id="add-experience" class="mt-4 text-indigo-600">Add More</button>
  </div>

  <div class="mt-6 flex justify-between">
    <button type="button" class="prev rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"">Previous</button>
    <button type="button" class="next bg-indigo-600 text-white px-4 py-2 rounded-md">Next</button>
  </div>
</div>


<!-- Step 4: Internships -->
<div class="step-content hidden" id="step-4">
  <div class="border-b border-gray-900/10 pb-12">
    <h2 class="text-base font-semibold text-gray-900">Internships</h2>
    <p class="mt-1 text-sm text-gray-600">Add your internship experience.</p>

    <div id="internship-container" class="mt-10">
      <div class="entry-form card p-6 shadow border border-gray-200 rounded-md mb-4">
        {{ internship_form.hidden_tag() }}

        <label for="company_name" class="block m-2 text-sm font-medium text-gray-900">Company Name</label>
        {{ internship_form.company_name(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="position" class="block m-2 text-sm font-medium text-gray-900">Position</label>
        {{ internship_form.position(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="start_date" class="block m-2 text-sm font-medium text-gray-900">Start Date</label>
        {{ internship_form.start_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="end_date" class="block m-2 text-sm font-medium text-gray-900">End Date</label>
        {{ internship_form.end_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label class="flex items-center gap-2">
          {{ internship_form.ongoing }}
          <span class="text-sm text-gray-900">Currently interning here</span>
        </label>

        <label for="job_description" class="block text-sm font-medium text-gray-900">Job Description</label>
        {{ internship_form.job_description(class_="block w-full rounded-md bg-white px-3 py-1.5") }}
      </div>
    </div>

    <button type="button" id="add-internship" class="mt-4 text-indigo-600">Add More</button>
  </div>

  <div class="mt-6 flex justify-between">
    <button type="button" class="prev rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Previous</button>
    <button type="button" class="next bg-indigo-600 text-white px-4 py-2 rounded-md">Next</button>
  </div>
</div>

<!-- Step 5: Projects -->
<div class="step-content hidden" id="step-5">
  <div class="border-b border-gray-900/10 pb-12">
    <h2 class="text-base font-semibold text-gray-900">Projects</h2>
    <p class="mt-1 text-sm text-gray-600">Add any projects you have worked on.</p>

    <div id="project-container" class="mt-10">
      <div class="entry-form card p-6 shadow border border-gray-200 rounded-md mb-4">
        {{ project_form.hidden_tag() }}

        <label for="title" class="block m-2 text-sm font-medium text-gray-900">Project Title</label>
        {{ project_form.title(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="description" class="block m-2 text-sm font-medium text-gray-900">Description</label>
        {{ project_form.description(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="project_url" class="block m-2 text-sm font-medium text-gray-900">Project URL</label>
        {{ project_form.project_url(class_="block w-full rounded-md bg-white px-3 py-1.5") }}
      </div>
    </div>

    <button type="button" id="add-project" class="mt-4 text-indigo-600">Add More</button>
  </div>

  <div class="mt-6 flex justify-between">
    <button type="button" class="prev rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"">Previous</button>
    <button type="button" class="next bg-indigo-600 text-white px-4 py-2 rounded-md">Next</button>
  </div>
</div>


<!-- Step 6: Accomplishments -->
<div class="step-content hidden" id="step-6">
  <div class="border-b border-gray-900/10 pb-12">
    <h2 class="text-base font-semibold text-gray-900">Accomplishments</h2>
    <p class="mt-1 text-sm text-gray-600">List any achievements or awards you have received.</p>

    <div id="accomplishment-container" class="mt-10">
      <div class="entry-form card p-6 shadow border border-gray-200 rounded-md mb-4">
        {{ accomplishment_form.hidden_tag() }}

        <label for="title" class="block m-2 text-sm font-medium text-gray-900">Title</label>
        {{ accomplishment_form.title(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="description" class="block m-2 text-sm font-medium text-gray-900">Description</label>
        {{ accomplishment_form.description(class_="block w-full rounded-md bg-white px-3 py-1.5") }}

        <label for="achievement_date" class="block m-2 text-sm font-medium text-gray-900">Achievement Date</label>
        {{ accomplishment_form.achievement_date(class_="block w-full rounded-md bg-white px-3 py-1.5") }}
      </div>
    </div>

    <button type="button" id="add-accomplishment" class="mt-4 text-indigo-600">Add More</button>
  </div>

  <div class="mt-6 flex justify-between">
    <button type="button" class="prev rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"">Previous</button>
    <button type="submit" class="submit bg-indigo-600 text-white px-4 py-2 rounded-md">Submit</button>
  </div>
</div>
</form>
</div>

<script>
  // Global step variables
  let currentStep = 1;
  const totalSteps = 6;

  // Show/hide the correct form content for each step
  function showStep(step) {
    // Hide all step contents
    document.querySelectorAll('.step-content').forEach(el => {
      el.classList.add('hidden');
    });

    // Show the current step content
    document.getElementById(`step-${step}`).classList.remove('hidden');
  }

  // Update the progress bar UI
  function updateProgressBar(step) {
    const steps = document.querySelectorAll('#progressBar .step');

    steps.forEach((el) => {
      const stepNumber = parseInt(el.getAttribute('data-step'), 10);

      // Grab the circle & circle text
      const circle = el.querySelector('.size-10');       // Outer circle
      const circleText = circle.querySelector('span');   // The step number inside the circle
      const titleText = el.querySelector('.ml-4');       // Step title
      const anchor = el.querySelector('a');              // Entire clickable area

      // Reset classes
      circle.className = 'flex size-10 shrink-0 items-center justify-center rounded-full';
      circleText.className = '';
      circleText.innerHTML = stepNumber;
      titleText.className = 'ml-4 text-sm font-medium';
      anchor.removeAttribute('aria-current');

      // If this step is completed
      if (stepNumber < step) {
        // COMPLETED: Blue background circle with check icon
        circle.classList.add('bg-indigo-600', 'group-hover:bg-indigo-800');
        circleText.innerHTML = `
          <svg class="size-6 text-white" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
          </svg>
        `;
        titleText.classList.add('text-gray-900');
      }
      // If this step is the current step
      else if (stepNumber === step) {
        // CURRENT: Blue border circle, number in blue
        circle.classList.add('border-2', 'border-indigo-600');
        circleText.classList.add('text-indigo-600');
        titleText.classList.add('text-indigo-600');
        anchor.setAttribute('aria-current', 'step');
      }
      // Otherwise it's an upcoming step
      else {
        // UPCOMING: Gray border circle, gray text
        circle.classList.add('border-2', 'border-gray-300', 'group-hover:border-gray-400');
        circleText.classList.add('text-gray-500', 'group-hover:text-gray-900');
        titleText.classList.add('text-gray-500', 'group-hover:text-gray-900');
      }
    });
  }

  // Initialize for step 1
  showStep(currentStep);
  updateProgressBar(currentStep);

  // Next buttons
  document.querySelectorAll('.next').forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
        updateProgressBar(currentStep);
      }
    });
  });

  // Previous buttons
  document.querySelectorAll('.prev').forEach(btn => {
    btn.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgressBar(currentStep);
      }
    });
  });
</script>
<script>

// Clone Entry Function for "Add More" Buttons
function cloneEntry(containerId) {
  const container = document.getElementById(containerId);
  const firstEntry = container.querySelector('.entry-form');
  const clone = firstEntry.cloneNode(true);

  // Reset input values
  clone.querySelectorAll('input, textarea').forEach(input => {
    input.value = "";
  });

  container.appendChild(clone);
}

// "Add More" Buttons for each Step
document.getElementById('add-education')?.addEventListener('click', () => {
  cloneEntry('education-container');
});

document.getElementById('add-experience')?.addEventListener('click', () => {
  cloneEntry('experience-container');
});

document.getElementById('add-internship')?.addEventListener('click', () => {
  cloneEntry('internship-container');
});

document.getElementById('add-project')?.addEventListener('click', () => {
  cloneEntry('project-container');
});

document.getElementById('add-accomplishment')?.addEventListener('click', () => {
  cloneEntry('accomplishment-container');
});

</script>

<script>
/**
 * Collects data from multiple cloned .entry-form sections and returns an array of objects.
 * @param {String} containerId - ID of the container that has repeated .entry-form blocks
 * @param {Array} fields       - Array of field configs: { name: 'fieldName', type: 'checkbox'|'text' }
 */
function collectRepeatedFields(containerId, fields) {
  const entriesData = [];
  const entryForms = document.querySelectorAll(`#${containerId} .entry-form`);

  entryForms.forEach(form => {
    const entryObj = {};
    fields.forEach(field => {
      const inputEl = form.querySelector(`[name="${field.name}"]`);
      if (!inputEl) return;

      if (field.type === 'checkbox') {
        entryObj[field.name] = inputEl.checked;
      } else {
        // text, date, textarea, etc.
        entryObj[field.name] = inputEl.value.trim();
      }
    });
    entriesData.push(entryObj);
  });
  return entriesData;
}

/**
 * Checks if an object is "completely empty" based on its values.
 * - For text fields, empty means "" (no content).
 * - For booleans, empty means false (not checked).
 * If ALL fields are empty, return true => we skip it.
 */
function isCompletelyEmpty(obj) {
  // If any field is a non-empty string or a true boolean, we say it's not empty
  for (const key in obj) {
    const val = obj[key];
    // If it's a string with some content, not empty
    if (typeof val === 'string' && val.trim() !== '') return false;
    // If it's a boolean and true, not empty
    if (typeof val === 'boolean' && val === true) return false;
  }
  // If we never returned false, then everything is empty/false
  return true;
}

// Listen for the final submit button
document.querySelector('.submit')?.addEventListener('click', function(evt) {
  // Prevent normal form submission (so we can gather JSON)
  evt.preventDefault();

  // 1. Collect raw form data
  const rawData = {};

  // Step 1: About
  rawData.about = document.querySelector('#step-1 textarea[name="about"]')?.value.trim() || '';

  // Step 2: Education
  rawData.education = collectRepeatedFields('education-container', [
    { name: 'institution_name', type: 'text' },
    { name: 'degree',           type: 'text' },
    { name: 'field_of_study',   type: 'text' },
    { name: 'start_date',       type: 'text' },
    { name: 'end_date',         type: 'text' },
    { name: 'ongoing',          type: 'checkbox' }
  ]);

  // Step 3: Experience
  rawData.experience = collectRepeatedFields('experience-container', [
    { name: 'company_name',     type: 'text' },
    { name: 'position',         type: 'text' },
    { name: 'start_date',       type: 'text' },
    { name: 'end_date',         type: 'text' },
    { name: 'ongoing',          type: 'checkbox' },
    { name: 'responsibilities', type: 'text' }
  ]);

  // Step 4: Internships
  rawData.internships = collectRepeatedFields('internship-container', [
    { name: 'company_name',     type: 'text' },
    { name: 'position',         type: 'text' },
    { name: 'start_date',       type: 'text' },
    { name: 'end_date',         type: 'text' },
    { name: 'ongoing',          type: 'checkbox' },
    { name: 'job_description',  type: 'text' }
  ]);

  // Step 5: Projects
  rawData.projects = collectRepeatedFields('project-container', [
    { name: 'title',        type: 'text' },
    { name: 'description',  type: 'text' },
    { name: 'project_url',  type: 'text' }
  ]);

  // Step 6: Accomplishments
  rawData.accomplishments = collectRepeatedFields('accomplishment-container', [
    { name: 'title',             type: 'text' },
    { name: 'description',       type: 'text' },
    { name: 'achievement_date',  type: 'text' }
  ]);

  /**
   * 2. Transform rawData -> Final JSON structure:
   *    - "about" -> "profile_summary.content"
   *    - "ongoing" -> "is_ongoing"
   *    - Filter out completely empty entries
   */
  const finalData = {};

  // (A) Profile Summary
  if (rawData.about) {
    finalData.profile_summary = { content: rawData.about };
  }

  // (B) Education
  if (rawData.education && rawData.education.length > 0) {
    const eduFiltered = rawData.education.map(item => ({
      institution_name: item.institution_name || "",
      degree: item.degree || "",
      field_of_study: item.field_of_study || "",
      start_date: item.start_date || "",
      end_date: item.end_date || "",
      is_ongoing: item.ongoing || false
    }))
    // Now filter out any that are all empty:
    .filter(entry => !isCompletelyEmpty(entry));

    if (eduFiltered.length > 0) {
      finalData.education = eduFiltered;
    }
  }

  // (C) Experience
  if (rawData.experience && rawData.experience.length > 0) {
    const expFiltered = rawData.experience.map(item => ({
      company_name: item.company_name || "",
      position: item.position || "",
      start_date: item.start_date || "",
      end_date: item.end_date || "",
      responsibilities: item.responsibilities || "",
      is_ongoing: item.ongoing || false
    }))
    .filter(entry => !isCompletelyEmpty(entry));

    if (expFiltered.length > 0) {
      finalData.experience = expFiltered;
    }
  }

  // (D) Internships
  if (rawData.internships && rawData.internships.length > 0) {
    const internFiltered = rawData.internships.map(item => ({
      company_name: item.company_name || "",
      position: item.position || "",
      start_date: item.start_date || "",
      end_date: item.end_date || "",
      job_description: item.job_description || "",
      is_ongoing: item.ongoing || false
    }))
    .filter(entry => !isCompletelyEmpty(entry));

    if (internFiltered.length > 0) {
      finalData.internships = internFiltered;
    }
  }

  // (E) Projects
  if (rawData.projects && rawData.projects.length > 0) {
    const projFiltered = rawData.projects.map(item => ({
      title: item.title || "",
      description: item.description || "",
      project_url: item.project_url || ""
    }))
    .filter(entry => !isCompletelyEmpty(entry));

    if (projFiltered.length > 0) {
      finalData.projects = projFiltered;
    }
  }

  // (F) Accomplishments
  if (rawData.accomplishments && rawData.accomplishments.length > 0) {
    const accomFiltered = rawData.accomplishments.map(item => ({
      title: item.title || "",
      description: item.description || "",
      achievement_date: item.achievement_date || ""
    }))
    .filter(entry => !isCompletelyEmpty(entry));

    if (accomFiltered.length > 0) {
      finalData.accomplishments = accomFiltered;
    }
  }

  // If you have "skills" or other fields, handle similarly and filter if needed.

  // 3. Convert finalData to JSON string
  const jsonPayload = JSON.stringify(finalData);
  console.log('Final JSON data (with empty entries removed):', jsonPayload);

  // 4. Send to server
  fetch("{{ url_for('jobseeker_update_profile') }}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: jsonPayload
  })
  .then(response => response.json())
  .then(data => {
    console.log("Server response:", data);
    if (data.success) {  // Check if the response contains success flag
      window.location.href = "{{ url_for('jobseeker_profile') }}";  // Redirect on success
    } else {
      alert("Error: " + (data.message || "Something went wrong"));
    }
  })
  .catch(error => console.error("Error submitting form:", error));
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ✅ Injected JSON from Flask (Replace this with actual fetched JSON)
    const resumeData = {{ resume_json | tojson | safe }} || {};

    if (!resumeData || Object.keys(resumeData).length === 0) {
        console.log("No JSON data found. Form remains empty.");
        return;
    }

    console.log("Populating stepper form with JSON data:", resumeData);

    // ✅ Populate "About" Section (Profile Summary)
    if (resumeData.profile_summary && resumeData.profile_summary.content) {
        document.querySelector('#step-1 textarea[name="about"]').value = resumeData.profile_summary.content;
    }

    /**
     * ✅ Generic function to populate repeated fields (Education, Experience, etc.)
     * @param {String} containerId - The ID of the container where entries should be added
     * @param {String} addMoreBtnId - The ID of the "Add More" button to trigger cloning
     * @param {Array} fieldData - The JSON array containing multiple entries
     * @param {Object} fieldMap - A mapping of JSON keys to form input names
     */
    function populateRepeatedFields(containerId, addMoreBtnId, fieldData, fieldMap) {
        const container = document.getElementById(containerId);

        fieldData.forEach((entry, index) => {
            if (index > 0) {
                document.getElementById(addMoreBtnId).click(); // Clone new field set
            }

            const entryForm = container.querySelectorAll('.entry-form')[index]; // Get the correct form
            if (!entryForm) return;

            // Map JSON fields to form inputs
            Object.entries(fieldMap).forEach(([jsonKey, inputName]) => {
                const inputEl = entryForm.querySelector(`[name="${inputName}"]`);
                if (inputEl) {
                    inputEl.value = entry[jsonKey] || "";
                }
            });

            // Handle "Ongoing" Checkbox
            if (entry.is_ongoing !== undefined) {
                const checkbox = entryForm.querySelector(`[name="ongoing"]`);
                if (checkbox) checkbox.checked = entry.is_ongoing;
            }
        });
    }

    // ✅ Populate Education
    if (resumeData.education && resumeData.education.length > 0) {
        populateRepeatedFields("education-container", "add-education", resumeData.education, {
            institution_name: "institution_name",
            degree: "degree",
            field_of_study: "field_of_study",
            start_date: "start_date",
            end_date: "end_date"
        });
    }

    // ✅ Populate Experience
    if (resumeData.experiences && resumeData.experiences.length > 0) {
        populateRepeatedFields("experience-container", "add-experience", resumeData.experiences, {
            company_name: "company_name",
            position: "position",
            start_date: "start_date",
            end_date: "end_date",
            responsibilities: "responsibilities"
        });
    }

    // ✅ Populate Internships
    if (resumeData.internships && resumeData.internships.length > 0) {
        populateRepeatedFields("internship-container", "add-internship", resumeData.internships, {
            company_name: "company_name",
            position: "position",
            start_date: "start_date",
            end_date: "end_date",
            job_description: "job_description"
        });
    }

    // ✅ Populate Projects
    if (resumeData.projects && resumeData.projects.length > 0) {
        populateRepeatedFields("project-container", "add-project", resumeData.projects, {
            title: "title",
            description: "description",
            project_url: "project_url"
        });
    }

    // ✅ Populate Accomplishments
    if (resumeData.accomplishments && resumeData.accomplishments.length > 0) {
        populateRepeatedFields("accomplishment-container", "add-accomplishment", resumeData.accomplishments, {
            title: "title",
            description: "description",
            achievement_date: "achievement_date"
        });
    }

    // ✅ Populate Skills (if applicable)
    if (resumeData.skills && resumeData.skills.length > 0) {
        const skillsInput = document.querySelector('input[name="skills"]');
        if (skillsInput) {
            skillsInput.value = resumeData.skills.join(", "); // Convert array to comma-separated string
        }
    }
});
</script>

{% endblock %}
