{% extends 'base.html' %}

{% block title %}Add Job{% endblock %}

{% block content %}



<style>
  #job_description .ql-editor,
  #job_requirements .ql-editor,
  #job_benefits .ql-editor {
    min-height: 200px;
  }
</style>

      <form method="post" action="{{ url_for('add_post') }}" id="addjobForm">
        {{ form.hidden_tag() }}

<div class="py-6 px-4 sm:px-6 lg:px-8">
  <div class="min-h-screen py-0">
    <div class="container max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center mb-6">
        <div class="sm:flex-auto">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Post New Job</h1>
        </div>
        <div class="flex space-x-4">  
          
        </div>
    </div>

        <div class="">
          <div class="grid grid-cols-12 gap-15">
            <div class="col-span-8 rounded-lg border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6  shadow-sm animate-fade-in">
              <div id="errorMessages" class="mb4 text-red-600 dark:text-red-400"></div>
          <div class="mb-4">
            <label for="job_title" class="block text-sm font-medium text-gray-900 mb-2">{{ form.job_title.label }}</label>
            {{ form.job_title(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-lg font-semibold text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600", id="job_title") }}
            {% if form.job_title.errors %}
            <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.job_title.errors[0] }}</p>
            {% endif %}
          </div>

          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mt-4">
            <div>
              <label for="industry" class="block text-sm font-medium text-gray-900 mb-2">{{ form.industry.label }}</label>
              {{ form.industry(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
            <div>
              <label for="job_type" class="block text-sm font-medium text-gray-900 mb-2">{{ form.job_type.label }}</label>
              {{ form.job_type(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
          </div>

                    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mt-4">
          <div>
            <label for="address_country" class="block text-sm font-medium text-gray-900 mb-2">{{ form.address_country.label }}</label>
            {{ form.address_country(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
          </div>
            <div>
              <label for="address_province" class="block text-sm font-medium text-gray-900 mb-2">{{ form.address_province.label }}</label>
              {{ form.address_province(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
          </div>

          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mt-4">
            <div>
              <label for="address_city" class="block text-sm font-medium text-gray-900 mb-2">{{ form.address_city.label }}</label>
              {{ form.address_city(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
            <div>
            <label for="address_postal_code" class="block text-sm font-medium text-gray-900 mb-2">{{ form.address_postal_code.label }}</label>
            {{ form.address_postal_code(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
          </div>
          </div>

          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mt-4">          
            <div>
              <label for="work_style" class="block text-sm font-medium text-gray-900 mb-2">{{ form.work_style.label }}</label>
              {{ form.work_style(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
            <div>
              <label for="work_experience" class="block text-sm font-medium text-gray-900 mb-2">{{ form.work_experience.label }}</label>
              {{ form.work_experience(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
            </div>
          </div>

          <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 mt-4">
            <div>
              <label for="min_salary" class="block text-sm font-medium text-gray-900 mb-2">{{ form.min_salary.label }}</label>
              <div class="flex">
                {{ form.salary_currency(class="mt-2 block w-16 rounded-l-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
                {{ form.min_salary(class="mt-2 block w-full rounded-r-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
              </div>
            </div>
            <div>
              <label for="max_salary" class="block text-sm font-medium text-gray-900 mb-2">{{ form.max_salary.label }}</label>
              <div class="flex">
                {{ form.max_salary(class="mt-2 block w-full rounded-l-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
                {{ form.salary_time_unit(class="mt-2 block w-20 rounded-r-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600") }}
              </div>
            </div>
          </div>

          <div class="mt-4">
  <div class="flex items-center justify-between">
  <label for="job_description" class="block text-sm font-medium text-gray-900 mb-2 mb-2">{{ form.job_description.label }}</label>
      <button type="button" id="generateAI" class="mt-0 flex bg-white border border-blue-600 text-blue-600 text-sm font-semibold px-2 py-1.5 justify-center rounded-md shadow-sm hover:bg-blue-50  focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="mr-2 size-5 text-blue-500">
  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
</svg>
     <p class=""> Generate by AI</p>
    </button>
    </div>

  <div class="relative">
    <div id="job_description"></div>
    {{ form.job_description(class="hidden block w-full rounded-md bg-white px-3 py-2 text-lg font-semibold text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-purple-600", id="hidden_job_description", rows="6") }}
  </div>
</div>

          <div class="mt-4">
            <label for="job_requirements" class="block text-sm font-medium text-gray-900 mb-2 mb-2">{{ form.job_requirements.label }}</label>
            <div id="job_requirements"></div>
            {{ form.job_requirements(class="hidden mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600", id="hidden_job_requirements", rows="6") }}
          </div>

          <div class="mt-4">
            <label for="job_benefits" class="block text-sm font-medium text-gray-900 mb-2 mb-2">{{ form.job_benefits.label }}</label>
            <div id="job_benefits"></div>
            {{ form.job_benefits(class="hidden mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600", id="hidden_job_benefits", rows="6") }}
          </div>
            </div>
            <!--Right Column-->
            <div class="col-span-4 rounded-lg border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 shadow-sm animate-fade-in">
            <div class="">
            <div>
              <label for="target_date" class="block text-sm font-medium text-gray-900 mb-2">{{ form.target_date.label }}</label>
            {{ form.target_date(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600", id="target_date") }}
            </div>
            <div class="mt-4 mb-5">
              <label for="opening_date" class="block text-sm font-medium text-gray-900 mb-2">{{ form.opening_date.label }}</label>
              {{ form.opening_date(class="mt-2 block w-full rounded-md bg-white px-3 py-2 text-base text-gray-900 outline outline-1 outline-gray-300 placeholder-gray-400 focus:outline-1 focus:-outline-offset-1 focus:outline-blue-600", id="opening_date") }}
          </div>
          <div>
          {{ form.save_draft(class="w-full items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background hover:bg-blue-50 hover:text-accent-foreground h-10 px-4 py-2 mb-4") }}
          {{form.publish(class="w-full items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary-foreground h-10 py-2 bg-blue-600 hover:bg-blue-700 px-4 text-white")}}
          </div>
          </div>
            </div>


          </div>

      </form>
    </div>


<!--End Salary Inputs-->

  </div>
  </div>
  </div>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script>
  // Initialize Quill Editor
  var quillOptions = {
    theme: 'snow',
    placeholder: 'Write something...',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link', 'blockquote', 'code-block'],
        ['clean']
      ]
    }
  };

  var quillRequirements = new Quill('#job_requirements', quillOptions);
  var quillBenefits = new Quill('#job_benefits', quillOptions);
  var quillDescription = new Quill('#job_description', quillOptions);

  // Add validation function
  function validateForm() {
    let isValid = true;
    const errorMessages = document.getElementById('errorMessages');
    errorMessages.innerHTML = ''; // Clear previous errors
    
    // Reset all error styles
    document.getElementById('job_title').classList.remove('outline-red-500', 'outline-2');
    document.getElementById('job_title').classList.add('outline-gray-300');
    
    // Remove error styles from Quill containers
    const quillContainers = document.querySelectorAll('.ql-container');
    quillContainers.forEach(container => {
      container.style.border = '';
    });
    
    // Validate Position field
    const jobTitle = document.getElementById('job_title').value.trim();
    if (!jobTitle) {
      isValid = false;
      document.getElementById('job_title').classList.remove('outline-gray-300');
      document.getElementById('job_title').classList.add('outline-red-500', 'outline-2');
      errorMessages.innerHTML += '<p class="text-sm text-red-600 dark:text-red-400">Position field is required.</p>';
    }
    
    // Validate Job Description field
    const jobDescription = quillDescription.root.innerHTML.trim();
    if (!jobDescription || jobDescription === '<p><br></p>' || jobDescription === '<p></p>') {
      isValid = false;
      // Add red border to Quill container
      const descriptionContainer = quillDescription.container.querySelector('.ql-container');
      if (descriptionContainer) {
        descriptionContainer.style.border = '2px solid #ef4444';
      }
      errorMessages.innerHTML += '<p class="text-sm text-red-600 dark:text-red-400">Job description field is required.</p>';
    }
    
    return isValid;
  }

  document.querySelector("#addjobForm").addEventListener('submit', function (e) {
    // Validate form before submission
    if (!validateForm()) {
      e.preventDefault();
      return false;
    }
    
    // If validation passes, set the hidden field values
    document.getElementById("hidden_job_description").value = quillDescription.root.innerHTML;
    document.getElementById("hidden_job_requirements").value = quillRequirements.root.innerHTML;
    document.getElementById("hidden_job_benefits").value = quillBenefits.root.innerHTML;
  });

  // Add real-time validation for job title
  document.getElementById('job_title').addEventListener('input', function() {
    const jobTitle = this.value.trim();
    if (jobTitle) {
      this.classList.remove('outline-red-500', 'outline-2');
      this.classList.add('outline-gray-300');
      // Clear error message if it exists
      const errorMessages = document.getElementById('errorMessages');
      const errorText = errorMessages.innerHTML;
      if (errorText.includes('Position field is required')) {
        errorMessages.innerHTML = errorText.replace(/<p class="text-sm text-red-600 dark:text-red-400">Position field is required\.<\/p>/, '');
      }
    }
  });

  // Add real-time validation for job description
  quillDescription.on('text-change', function() {
    const jobDescription = quillDescription.root.innerHTML.trim();
    const descriptionContainer = quillDescription.container.querySelector('.ql-container');
    
    if (jobDescription && jobDescription !== '<p><br></p>' && jobDescription !== '<p></p>') {
      if (descriptionContainer) {
        descriptionContainer.style.border = '';
      }
      // Clear error message if it exists
      const errorMessages = document.getElementById('errorMessages');
      const errorText = errorMessages.innerHTML;
      if (errorText.includes('Job description field is required')) {
        errorMessages.innerHTML = errorText.replace(/<p class="text-sm text-red-600 dark:text-red-400">Job description field is required\.<\/p>/, '');
      }
    }
  });




  document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('generateAI').addEventListener('click', function () {
    const position = document.getElementById('job_title').value.trim();

    if (!position) {
      alert("Please fill in the Position field before generating the job description.");
      return;
    }

    const jobDetails = { position }; // Position is mandatory

    // List of optional fields
    const optionalFields = ['salary', 'work_experience', 'job_type', 'industry', 'country', 'province', 'city'];

    // Dynamically add only non-empty fields to jobDetails
    optionalFields.forEach(field => {
      const element = document.getElementById(field);
      if (element && element.value.trim()) {
        jobDetails[field] = element.value.trim();
      }
    });

    fetch('/generate-ai-content', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ field: 'job_description', prompt: jobDetails })
    })
      .then(response => response.json())
      .then(data => {
    if (data.success && data.content) {
        // Assuming AI response is a structured JSON object with job_description, job_requirements, and job_benefits

        if (typeof quillDescription !== 'undefined') {
            quillDescription.root.innerHTML = (data.content.job_description || '').split('\n').map(line => `<p>${line}</p>`).join(''); ;
            console.log(quillDescription.root.innerHTML);
        } else {
            document.getElementById('job_description').value = data.content.job_description || '';
        }

        if (typeof quillRequirements !== 'undefined') {
            quillRequirements.root.innerHTML = (data.content.job_requirements || '').split('\n').map(line => `<p>${line}</p>`).join('');;
            console.log(quillRequirements.root.innerHTML);
        } else {
            document.getElementById('job_requirements').value = data.content.job_requirements || '';
        }

        if (typeof quillBenefits !== 'undefined') {
            quillBenefits.root.innerHTML = (data.content.job_benefits || '').split('\n').map(line => `<p>${line}</p>`).join('');;
            console.log(quillBenefits.root.innerHTML);
        } else {
            document.getElementById('job_benefits').value = data.content.job_benefits || '';
        }
    } else {
        alert('Failed to generate content. Please try again.');
    }
      })
      .catch(error => {
        console.error('Error generating content:', error);
        alert('An error occurred while generating content.');
      });
  });
});

</script>

<script>
</script>
{% endblock %}
