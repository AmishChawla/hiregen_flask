{% extends 'admin_base.html' %}
{% block title %}User's all posts{% endblock %}
{% block content %}
<style>
  #publishedTable_wrapper .dt-layout-row:nth-child(1), .dt-layout-row:nth-child(3) {
    width: 98%!important;
    margin: 0 auto!important;
    font-size: 14px;
    color: #6b7280;
  }

div.dt-container .dt-paging .dt-paging-button:hover {
    background: #a6a2f5!important;
    border-radius: 4px !important;
}
.dt-paging-button.current {
  background-color: #eee !important;
  color: #fff !important;
  border-radius: 4px !important;
  opacity: 1 !important;
}
.dt-start .dt-input {
  margin-right:8px;
  border: 1px solid #d1d5db !important;
}
.dt-search .dt-input {
  margin-left:10px!important;
  border: 1px solid #d1d5db !important;
}
table.dataTable thead th, table.dataTable tfoot th {
    font-weight: 500;
    text-transform: uppercase;
    font-size: 12px;
}
</style>
<link href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" rel="stylesheet">

<div class="">
    <div class="min-h-screen py-0">
      <div class="containerr mxauto px-4 sm:px-6 lg:px-0">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Posts</h1>
            </div>
            <div>
                <a href="{{ url_for('add_cms_post') }}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary-foreground h-10 py-2 bg-blue-600 hover:bg-blue-700 px-4 text-white">
                    New Post
                </a>
            </div>
        </div>

        <div class="rounded-lg border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6  shadow-sm animate-fade-in">
            <div class="flow-root">
            <div class="hidden sm:block">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8" id="postTabs">
                        <a href="#published-posts" class="whitespace-nowrap border-b-2 border-purple-300 px-1 py-4 text-sm font-medium text-purple-500" id="published-tab">Published</a>
                        <a href="#draft-posts" class="whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:text-gray-700" id="drafts-tab">Drafts</a>
                    </nav>
                </div>
            </div>

                <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-6">
                    <div id="published-posts" class="inline-block min-w-full align-middle">
                    <table id="publishedTable" class="min-w-full borderseparate border-spacing-0">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="table-headerrounded-tl-lg">Title</th>
                            <th class="table-header">Author</th>
                            <th class="table-header">Category</th>
                            <th class="table-header">Tags</th>
                            <th class="table-header">Views</th>
                            <th class="table-header">Created Date</th>
                            <th class="table-header">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for data in result %}
                        {%  if data.status == 'published' %}
                        <tr class="hover:bg-gray-50">
                            <td class="whitespace-nowrap border-b border-gray-200 py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6 lg:pl-8">
                                <div class="flex items-center space-x-2">
                                <img src="/static/images/man.png" alt="Profile" class="h-10 w-10 rounded-full object-cover border border-purple-100">
                                <a href="{{ url_for('read_post', slug=data.slug) }}" class="text-purple500 hover:underline">{{ data.title }}</a>
                                </div>
                            </td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.username }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.category_name }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{% if data.tags %}{% for tag in data.tags %}{{ tag }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %} No Tags {% endif %}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.post_views }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.created_at }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">
                                <a href="{{ url_for('admin_update_cms_post', post_id=data.id) }}" class="text-blue-600 hover:text-blue-500 mr-4">Edit</a>
                                <button data-post-id="{{ data.id }}" class="deleteModalTrigger text-blue-600 hover:text-blue-500">Delete</button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>

            <div id="draft-posts" class="hidden">
                <table id="draftTable" class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="table-headerrounded-tl-lg">Title</th>
                            <th class="table-header">Author</th>
                            <th class="table-header">Category</th>
                            <th class="table-header">Tags</th>
                            <th class="table-header">Created Date</th>
                            <th class="table-header">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for data in result if data.status == 'draft' %}
                        {%  if data.status == 'draft' %}
                        <tr>
                            <td class="whitespace-nowrap border-b border-gray-200 py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6 lg:pl-8"><a href="#" class="text-purple500 hover:underline">{{ data.title }}</a></td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.username }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.category_name }}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{% if data.tags %}{% for tag in data.tags %}{{ tag }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %} No Tags {% endif %}</td>
                            <td class="whitespace-nowrap border-b border-gray-200 hidden px-3 py-4 text-sm text-gray-500 sm:table-cell">{{ data.created_at }}</td>
                            <td class="px-4 py-2 text-sm">
                                <a href="{{ url_for('admin_update_cms_post', post_id=data.id) }}" class="text-blue-600 hover:text-blue-500 mr-4">Edit</a>
                                <button data-post-id="{{ data.id }}" class="deleteModalTrigger text-blue-600 hover:text-blue-500">Delete</button>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="relative z-10 hidden" id="deleteModal" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                        <h3 class="text-base font-semibold text-gray-900" id="modal-title">Delete Post</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Are you sure you want to delete this post? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <a href="#" id="confirmDelete" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">Delete</a>
                    <button type="button" id="cancelModal" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const publishedTab = document.getElementById('published-tab');
        const draftsTab = document.getElementById('drafts-tab');
        const publishedTable = document.getElementById('published-posts');
        const draftTable = document.getElementById('draft-posts');

        publishedTab.addEventListener('click', () => {
            publishedTab.classList.add('text-purple-500', 'border-purple-300');
            draftsTab.classList.remove('text-purple-500', 'border-purple-300');
            publishedTable.classList.remove('hidden');
            draftTable.classList.add('hidden');
        });

        draftsTab.addEventListener('click', () => {
            draftsTab.classList.add('text-purple-500', 'border-purple-300');
            publishedTab.classList.remove('text-purple-500', 'border-purple-300');
            draftTable.classList.remove('hidden');
            publishedTable.classList.add('hidden');
        });

        // Initialize DataTables
        new DataTable('#publishedTable');
        new DataTable('#draftTable');

        // Modal Logic
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        const cancelModalButton = document.getElementById('cancelModal');

        document.addEventListener('click', function (e) {
            if (e.target && e.target.classList.contains('deleteModalTrigger')) {
                const postId = e.target.getAttribute('data-post-id');
                confirmDeleteButton.href = `/admin/delete-posts/${postId}`;
                deleteModal.classList.remove('hidden');
            }
        });


        cancelModalButton.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
        });
    });
</script>
{% endblock %}
