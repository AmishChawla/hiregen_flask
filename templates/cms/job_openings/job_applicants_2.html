{% extends 'base.html' %}

{% block title %}Applicants{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.0.0/dist/tailwind.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>

<style>
    .draggable-item {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .draggable-item.is-dragging {
        transform: scale(1.05);
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        background-color: #e2e8f0;
    }
    .draggable-list {
        transition: background-color 0.2s ease-in-out;
    }
    .draggable-list.is-hovered {
        background-color: #edf2f7;
    }
    .kanban-column {
        min-width: 20rem;
    }
    .drawer {
        position: fixed;
        top: 0;
        right: -100%;
        width: 24rem;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 8px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease-in-out;
        z-index: 50;
        overflow-y: auto;
        border-left: 1px solid #e5e7eb;
    }
    .drawer.open {
        right: 0;
    }
    .drawer-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .drawer-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .drawer-content {
        padding: 1rem;
    }
    .drawer-content p {
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: #374151;
    }
    .drawer-content a {
        color: #3b82f6;
        text-decoration: underline;
    }
</style>

<div class="container mx-auto p-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Applicant Tracking</h1>
        <button id="toggleView" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Switch to Table View
        </button>
    </div>

    <!-- Kanban View -->
    <div id="kanbanView" class="flex space-x-4 overflow-x-auto">
        {% for status in ['applied', 'shortlisted', 'assessment', 'interview', 'rejected', 'selected'] %}
        <div class="kanban-column bg-white rounded-lg shadow-md w-80 min-h-[70vh] p-4" data-status="{{ status }}">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700">{{ status.capitalize() }}</h3>
            <label class="text-xs font-medium text-gray-600 flex items-center space-x-1">
                <input type="checkbox" class="select-all-checkbox w-4 h-4 text-purple-600 border-gray-300 rounded" data-status="{{ status }}">
                <span id="select-text-{{ status }}">Select All</span>
            </label>
        </div>
                    <!-- Search and Sort Input -->
            <div class="mb-4">
                <div>
                    <div class="mt-2 flex">
                        <div class="-mr-px grid grow grid-cols-1 focus-within:relative">
                            <input type="text" name="query_{{ status }}" id="query_{{ status }}" class="col-start-1 row-start-1 block w-full rounded-l-md bg-white py-1.5 pl-10 pr-3 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:pl-9 sm:text-sm/6" placeholder="John Smith">
                            <svg class="pointer-events-none col-start-1 row-start-1 ml-3 size-5 self-center text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
                                <path d="M8.5 4.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10.9 12.006c.11.542-.348.994-.9.994H2c-.553 0-1.01-.452-.902-.994a5.002 5.002 0 0 1 9.803 0ZM14.002 12h-1.59a2.556 2.556 0 0 0-.04-.29 6.476 6.476 0 0 0-1.167-2.603 3.002 3.002 0 0 1 3.633 1.911c.18.522-.283.982-.836.982ZM12 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" />
                            </svg>
                        </div>
                        <button type="button" data-status="{{ status }}" class="filter-button flex shrink-0 items-center gap-x-1.5 rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 hover:bg-gray-50 focus:relative focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 text-gray-400">
                              <path fill-rule="evenodd" d="M3.792 2.938A49.069 49.069 0 0 1 12 2.25c2.797 0 5.54.236 8.209.688a1.857 1.857 0 0 1 1.541 1.836v1.044a3 3 0 0 1-.879 2.121l-6.182 6.182a1.5 1.5 0 0 0-.439 1.061v2.927a3 3 0 0 1-1.658 2.684l-1.757.878A.75.75 0 0 1 9.75 21v-5.818a1.5 1.5 0 0 0-.44-1.06L3.13 7.938a3 3 0 0 1-.879-2.121V4.774c0-.897.64-1.683 1.542-1.836Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Filter Panel (Initially Hidden) -->
            <div class="hidden filter-dropdown bg-white rounded-lg shadow-md p-4 border border-gray-200 absolute z-50" id="filter-panel-{{ status }}">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Filter by Score</h4>

        <label class="block text-sm font-medium text-gray-900">Overall Score</label>
        <input type="number" id="min-score-{{ status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-score-{{ status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Experience</label>
        <input type="number" id="min-exp-{{ status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-exp-{{ status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Education</label>
        <input type="number" id="min-edu-{{ status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-edu-{{ status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Skills</label>
        <input type="number" id="min-skill-{{ status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-skill-{{ status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <button type="button" class="apply-filter bg-indigo-600 text-white px-3 py-2 rounded-md w-full mt-3" data-status="{{ status }}">
            Apply Filter
        </button>
    </div>
            <button id="move-btn-{{ status }}" class="hidden my-1 w-full rounded bg-indigo-600 px-2 py-1 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" onclick="moveToNextStage('{{ status }}')">
                Move to Next Stage
            </button>


            <ul class="space-y-4 draggable-list w-72" data-status="{{ status }}">
                {% if result | selectattr('application_status', 'equalto', status) | list | length == 0 %}
                <li class="bg-gray-100 p-4 rounded-lg text-center text-gray-400 draggable-placeholder">No Applicants</li>
                {% endif %}
                {% for data in result %}
                {% if data.application_status == status %}
                <li class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow draggable-item flex justify-between items-center space-x-4"
                data-id="{{ data.application_id }}"
                data-status="{{ data.application_status }}"
                data-overall-score="{{ data.similarity_scores.overall_score }}"
                data-experience-score="{{ data.similarity_scores.experience_embedding }}"
                data-education-score="{{ data.similarity_scores.education_embedding }}"
                data-skill-score="{{ data.similarity_scores.skill_embedding }}"
                data-leadership-score="{{ data.similarity_scores.leadership_embedding }}"
                data-industry-score="{{ data.similarity_scores.industry_embedding }}">
    <!-- Left Section: Profile Picture and Info -->
    <div class="flex items-center space-x-1 overflow-hidden">
        <input type="checkbox" class="applicant-checkbox w-4 h-4 text-purple-600 border-gray-300 rounded" data-status="{{ status }}">

        <!-- Profile Picture -->
        <img src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/man.png') }}" alt="{{ data.applicant_name }}'s profile picture" class="w-12 h-12 rounded-full border border-gray-200 flex-shrink-0">

        <!-- Applicant Info -->
        <div class="flex-1 min-w-0">
            <p class="text-gray-800 font-semibold text-sm truncate" title="{{ data.applicant_name }}">{{ data.applicant_name }}</p>
            <p class="text-gray-500 text-xs truncate" title="{{ data.applicant_email }}">{{ data.applicant_email }}</p>
        </div>
    </div>

    <!-- Right Section: Similarity Score -->
    <div class="flex items-center space-x-1">
        <!-- Similarity Score -->
        <div class="bg-white text-gray-600 text-sm font-medium p-1 rounded-full text-center flex border-2 border-gray-300">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="mt-1 mr-1 size-5 text-yellow-500">
  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
</svg>
            <p class="text-lg">{{ data.similarity_scores.overall_score }}</p>
        </div>

        <!-- Action Button -->
        <button onclick="openDrawer({{ data.application_id }}, '{{ data.applicant_name }}', '{{ data.applicant_email }}', '{{ data.application_date }}', '{{ data.resume }}', '{{data.similarity_scores.overall_score}}', '{{data.similarity_scores.experience_embedding}}', '{{data.similarity_scores.education_embedding}}', '{{data.similarity_scores.skill_embedding}}', '{{data.similarity_scores.leadership_embedding}}', '{{data.similarity_scores.industry_embedding}}')" class="text-gray-500 hover:text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
        </button>
    </div>
</li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div id="tableView" class="hidden">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="sm:flex sm:items-center">
                <div class="sm:flex-auto">
                    <h1 class="text-base font-semibold text-gray-900">Applicants</h1>
                    <p class="mt-2 text-sm text-gray-700">A list of all applicants including their name, email, status, and application date.</p>
                </div>
            </div>
            <div class="mt-8 flow-root">
                <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead>
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Name</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Email</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Applied On</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                {% for data in result %}
                                <tr>
                                    <td class="whitespace-nowrap py-5 pl-4 pr-3 text-sm sm:pl-0">
                                        <div class="flex items-center">
                                            <img class="w-10 h-10 rounded-full" src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/default.png') }}" alt="">
                                            <div class="ml-4">
                                                <div class="font-medium text-gray-900">{{ data.applicant_name }}</div>
                                                <div class="mt-1 text-gray-500">{{ data.applicant_email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.applicant_email }}</td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.application_status }}</td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.application_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drawer (Initially Hidden) -->
<div id="applicantDrawer" class="relative z-10 hidden" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
  <!-- Background Overlay -->
  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

  <div class="fixed inset-0 overflow-hidden">
    <div class="absolute inset-0 overflow-hidden">
      <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
        <!-- Slide-over panel -->
        <div class="pointer-events-auto w-screen max-w-2xl transform transition ease-in-out duration-500 sm:duration-700 translate-x-full" id="drawerPanel">
          <div class="flex h-full flex-col overflow-y-scroll bg-white shadow-xl">
            <div class="flex-1">
              <!-- Header -->
              <div class="bg-white px-4 py-6 sm:px-6">
                <div class="flex items-start justify-between space-x-3">
                  <div class="px-4 sm:px-0">
                    <h3 class="text-base font-semibold text-gray-900">Applicant Information</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">Personal details and application.</p>
                  </div>
                  <div class="flex h-7 items-center">
                    <button type="button" class="relative text-gray-400 hover:text-gray-500" onclick="closeDrawer()">
                      <span class="absolute -inset-2.5"></span>
                      <span class="sr-only">Close panel</span>
                      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Applicant Information -->
              <div class="space-y-6 py-6 sm:space-y-0 sm:divide-y sm:divide-gray-200 sm:py-0 px-6" id="drawerContent">
                <div>
                  <div class="mt-6 border-t border-gray-100">
                    <dl class="divide-y divide-gray-100">
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Full name</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicantName"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Email address</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicantEmail"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Applied On</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicationDate"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Overall Score</dt>
                        <dd class="mt-1 sm:col-span-2 sm:mt-0">
                          <!-- Gauge for Overall Score -->
                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeOverall" cx="18" cy="18" r="16" fill="none" class="stroke-current text-blue-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerOverallScore" class="text-4xl font-bold text-blue-600">0</span>
                              <span class="text-blue-600 block">Overall</span>
                            </div>
                          </div>
                        </dd>
                      </div>

                      <!-- Detailed Scores Section -->
                      <div class="px-4 py-6 sm:grid sm:grid-cols-1 gap-4 sm:px-0">
                        <h3 class="text-sm font-medium text-gray-900 mb-4">Detailed Scores</h3>
                        <div class="grid grid-cols-3 gap-4">
                          <!-- Individual Gauges -->
                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeExperience" cx="18" cy="18" r="16" fill="none" class="stroke-current text-green-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerExperienceScore" class="text-4xl font-bold text-green-600">0</span>
                              <span class="text-green-600 block">Experience</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeEducation" cx="18" cy="18" r="16" fill="none" class="stroke-current text-yellow-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerEducationScore" class="text-4xl font-bold text-yellow-500">0</span>
                              <span class="text-yellow-500 block">Education</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeSkills" cx="18" cy="18" r="16" fill="none" class="stroke-current text-red-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerSkillScore" class="text-4xl font-bold text-red-600">0</span>
                              <span class="text-red-600 block">Skills</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeLeadership" cx="18" cy="18" r="16" fill="none" class="stroke-current text-purple-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerLeadershipScore" class="text-4xl font-bold text-purple-600">0</span>
                              <span class="text-purple-600 block">Leadership</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeIndustry" cx="18" cy="18" r="16" fill="none" class="stroke-current text-orange-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerIndustryScore" class="text-4xl font-bold text-orange-500">0</span>
                              <span class="text-orange-500 block">Industry</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <!-- Close Button -->
            <div class="shrink-0 border-t border-gray-200 px-4 py-5 sm:px-6">
              <div class="flex justify-end space-x-3">
                <button type="button" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" onclick="closeDrawer()">Close</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function openDrawer(id, name, email, date, resume, overallScore, experienceScore, educationScore, skillScore, leadershipScore, industryScore) {
      const drawer = document.getElementById('applicantDrawer');
      const drawerPanel = document.getElementById('drawerPanel');

      // Update static content
      document.getElementById('drawerApplicantName').textContent = name;
      document.getElementById('drawerApplicantEmail').textContent = email;
      document.getElementById('drawerApplicationDate').textContent = date;

      const resumeLink = document.getElementById('drawerResumeLink');
      if (resumeLink) resumeLink.href = resume || '#';

      // Update gauges
      const updateGauge = (gaugeId, textId, score) => {
          const gauge = document.getElementById(gaugeId);
          const text = document.getElementById(textId);
          if (gauge && text) {
              text.textContent = score;
              gauge.setAttribute('stroke-dasharray', `${(score / 100) * 75} 100`);
          }
      };

      updateGauge('drawerGaugeOverall', 'drawerOverallScore', overallScore);
      updateGauge('drawerGaugeExperience', 'drawerExperienceScore', experienceScore);
      updateGauge('drawerGaugeEducation', 'drawerEducationScore', educationScore);
      updateGauge('drawerGaugeSkills', 'drawerSkillScore', skillScore);
      updateGauge('drawerGaugeLeadership', 'drawerLeadershipScore', leadershipScore);
      updateGauge('drawerGaugeIndustry', 'drawerIndustryScore', industryScore);

      // Open drawer
      drawer.classList.remove('hidden');
      setTimeout(() => {
          drawerPanel.classList.remove('translate-x-full');
      }, 10);
  }

  function closeDrawer() {
      const drawerPanel = document.getElementById('drawerPanel');
      drawerPanel.classList.add('translate-x-full');
      setTimeout(() => {
          document.getElementById('applicantDrawer').classList.add('hidden');
      }, 500);
  }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const containers = Array.from(document.querySelectorAll('.draggable-list'));

        const drake = dragula(containers, {
            moves: function(el, container, handle) {
                return el.classList.contains('draggable-item'); // Allow dragging only for items with this class
            },
            accepts: function(el, target) {
                return target.classList.contains('draggable-list'); // Ensure valid drop targets
            },
            mirrorContainer: document.body // Append the drag mirror to the body for smooth dragging
        });

        drake.on('drag', function(el) {
            el.classList.add('is-dragging');
        });

        drake.on('dragend', function(el) {
            el.classList.remove('is-dragging');
        });

        drake.on('over', function(el, container) {
            container.classList.add('is-hovered');
        });

        drake.on('out', function(el, container) {
            container.classList.remove('is-hovered');
        });

        drake.on('drop', function(el, target, source) {
            if (target && target !== source) {
                const placeholder = target.querySelector('.draggable-placeholder');
                if (placeholder) placeholder.remove(); // Remove placeholder if exists in target

                if (!source.querySelector('.draggable-item')) {
                    const newPlaceholder = document.createElement('li');
                    newPlaceholder.className = 'bg-gray-100 p-4 rounded-lg text-center text-gray-400 draggable-placeholder';
                    newPlaceholder.textContent = 'No Applicants';
                    source.appendChild(newPlaceholder);
                }

                target.appendChild(el); // Append the element to the new container

                // Update the status data attribute
                const newStatus = target.dataset.status;
                el.setAttribute('data-status', newStatus);

                // Make API call to update application status
                const applicationId = el.getAttribute('data-id');

                fetch('/update-application-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: applicationId, newStatus: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Status updated successfully:', data);
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                });

                console.log(`Element ${applicationId} dropped into ${newStatus}`);
            } else {
                source.appendChild(el); // Return to the source container if invalid drop
                console.log('Invalid drop, returned to source.');
            }
        });

        drake.on('cancel', function(el) {
            el.classList.remove('is-dragging');
            console.log('Drag canceled.');
        });
    });
</script>
<script>
    function toggleView() {
        const kanbanView = document.getElementById('kanbanView');
        const tableView = document.getElementById('tableView');
        const toggleButton = document.getElementById('toggleView');

        if (kanbanView.classList.contains('hidden')) {
            kanbanView.classList.remove('hidden');
            tableView.classList.add('hidden');
            toggleButton.textContent = 'Switch to Table View';
        } else {
            kanbanView.classList.add('hidden');
            tableView.classList.remove('hidden');
            toggleButton.textContent = 'Switch to Kanban View';
        }
    }

    document.getElementById('toggleView').addEventListener('click', toggleView);
</script>
<script>
    // Function to filter applicants based on input in the search bar
    document.querySelectorAll('input[id^="query_"]').forEach((inputField) => {
        inputField.addEventListener("input", function (e) {
            const query = e.target.value.toLowerCase(); // Get the search query
            const status = e.target.id.replace("query_", ""); // Extract the status from the input field's ID
            const kanbanColumn = document.querySelector(`ul[data-status="${status}"]`); // Find the corresponding Kanban column

            if (kanbanColumn) {
                const items = kanbanColumn.querySelectorAll("li"); // Get all applicants in the column
                let hasMatch = false;

                items.forEach((item) => {
                    const nameElement = item.querySelector("p.text-gray-800");
                    const emailElement = item.querySelector("p.text-gray-500");

                    if (!nameElement || !emailElement) return; // Skip placeholder or non-applicant items

                    const name = nameElement.textContent.toLowerCase();
                    const email = emailElement.textContent.toLowerCase();

                    if (name.includes(query) || email.includes(query)) {
                        item.style.display = ""; // Show matching applicants
                        hasMatch = true;
                    } else {
                        item.style.display = "none"; // Hide non-matching applicants
                    }
                });

                // Show placeholder text if no applicants match
                const placeholder = kanbanColumn.querySelector(".draggable-placeholder");
                if (placeholder) {
                    placeholder.style.display = hasMatch ? "none" : ""; // Toggle placeholder visibility
                }
            }
        });
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… JavaScript Loaded");

    // Toggle filter panel
    document.querySelectorAll(".filter-button").forEach(button => {
        button.addEventListener("click", function () {
            let status = this.getAttribute("data-status");
            let filterPanel = document.getElementById(`filter-panel-${status}`);

            if (!status || !filterPanel) {
                console.error(`âŒ Error: Filter panel for '${status}' not found!`);
                return;
            }

            console.log(`Toggling filter panel for: ${status}`);

            // Hide other filter panels
            document.querySelectorAll(".filter-dropdown").forEach(panel => {
                if (panel !== filterPanel) {
                    panel.classList.add("hidden");
                }
            });

            // Toggle the visibility of the filter panel
            filterPanel.classList.toggle("hidden");
        });
    });

    // Apply filter logic
    document.querySelectorAll(".apply-filter").forEach(button => {
        button.addEventListener("click", function () {
            let status = this.getAttribute("data-status");
            let filterPanel = document.getElementById(`filter-panel-${status}`);

            if (!filterPanel) {
                console.error(`âŒ Error: Filter panel for '${status}' not found!`);
                return;
            }

            // Get filter values
            let minOverall = parseFloat(document.getElementById(`min-score-${status}`).value) || 0;
            let maxOverall = parseFloat(document.getElementById(`max-score-${status}`).value) || 100;

            let minExp = parseFloat(document.getElementById(`min-exp-${status}`).value) || 0;
            let maxExp = parseFloat(document.getElementById(`max-exp-${status}`).value) || 100;

            let minEdu = parseFloat(document.getElementById(`min-edu-${status}`).value) || 0;
            let maxEdu = parseFloat(document.getElementById(`max-edu-${status}`).value) || 100;

            let minSkill = parseFloat(document.getElementById(`min-skill-${status}`).value) || 0;
            let maxSkill = parseFloat(document.getElementById(`max-skill-${status}`).value) || 100;

            console.log(`ðŸŽ¯ Applying filter for ${status}:
            - Overall: ${minOverall} to ${maxOverall}
            - Experience: ${minExp} to ${maxExp}
            - Education: ${minEdu} to ${maxEdu}
            - Skills: ${minSkill} to ${maxSkill}`);

            // Filter applicants based on input values
            document.querySelectorAll(`.kanban-column[data-status="${status}"] .draggable-item`).forEach(item => {
                let overallScore = parseFloat(item.getAttribute("data-overall-score"));
                let experienceScore = parseFloat(item.getAttribute("data-experience-score"));
                let educationScore = parseFloat(item.getAttribute("data-education-score"));
                let skillScore = parseFloat(item.getAttribute("data-skill-score"));

                let matchesFilter =
                    overallScore >= minOverall && overallScore <= maxOverall &&
                    experienceScore >= minExp && experienceScore <= maxExp &&
                    educationScore >= minEdu && educationScore <= maxEdu &&
                    skillScore >= minSkill && skillScore <= maxSkill;

                if (matchesFilter) {
                    item.classList.remove("hidden");
                } else {
                    item.classList.add("hidden");
                }
            });

            // Hide filter panel after applying
            filterPanel.classList.add("hidden");
        });
    });

    // Close filter dropdown if clicked outside
    document.addEventListener("click", function (event) {
        document.querySelectorAll(".filter-dropdown").forEach(panel => {
            if (!panel.contains(event.target) && !event.target.closest(".filter-button")) {
                panel.classList.add("hidden");
            }
        });
    });
});
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    console.log("âœ… JavaScript Loaded");

    // Select All Functionality
    document.querySelectorAll(".select-all-checkbox").forEach(selectAllCheckbox => {
        selectAllCheckbox.addEventListener("change", function () {
            let status = this.getAttribute("data-status");
            let isChecked = this.checked;
            let selectText = document.getElementById(`select-text-${status}`);
            let checkboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);

            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                checkbox.classList.toggle("bg-purple-600", isChecked);
            });

            // Update text
            selectText.textContent = isChecked ? "Selected" : "Select All";
            updateMoveButton(status);
        });
    });

    // Individual Checkbox Selection
    document.querySelectorAll(".applicant-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", function () {
            let status = this.getAttribute("data-status");
            let selectAllCheckbox = document.querySelector(`.select-all-checkbox[data-status="${status}"]`);
            let selectText = document.getElementById(`select-text-${status}`);
            let allCheckboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);
            let allChecked = Array.from(allCheckboxes).every(cb => cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectText.textContent = allChecked ? "Selected" : "Select All";

            // Change checkbox color when selected
            this.classList.toggle("bg-purple-600", this.checked);
            updateMoveButton(status);
        });
    });

    // Function to show/hide "Move to Next Stage" button
    function updateMoveButton(status) {
        let checkboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);
        let moveBtn = document.getElementById(`move-btn-${status}`);
        let anyChecked = Array.from(checkboxes).some(cb => cb.checked);

        if (anyChecked) {
            moveBtn.classList.remove("hidden");
        } else {
            moveBtn.classList.add("hidden");
        }
    }
});

function moveToNextStage(currentStatus) {
    let checkboxes = document.querySelectorAll(`.kanban-column[data-status="${currentStatus}"] .applicant-checkbox:checked`);
    let selectedApplicants = [];

    checkboxes.forEach(cb => {
        let applicantCard = cb.closest("li");
        let applicationId = applicantCard.getAttribute("data-id");
        selectedApplicants.push({ id: applicationId, element: applicantCard });
    });

    if (selectedApplicants.length === 0) {
        console.log("âŒ No applicants selected.");
        return;
    }

    // Determine next status
    let statusOrder = ['applied', 'shortlisted', 'assessment', 'interview', 'rejected', 'selected'];
    let currentIndex = statusOrder.indexOf(currentStatus);
    let newStatus = (currentIndex >= 0 && currentIndex < statusOrder.length - 1) ? statusOrder[currentIndex + 1] : 'selected';

    console.log(`ðŸš€ Moving applicants to next stage: ${newStatus}`);

    // Target kanban column for new status
    let targetColumn = document.querySelector(`.kanban-column[data-status="${newStatus}"] .draggable-list`);
    let sourceColumn = document.querySelector(`.kanban-column[data-status="${currentStatus}"] .draggable-list`);

    selectedApplicants.forEach(({ id, element }) => {
        // Update UI immediately
        element.setAttribute("data-status", newStatus);
        targetColumn.appendChild(element); // Move to new column

        // Remove placeholder if exists in new column
        let placeholder = targetColumn.querySelector('.draggable-placeholder');
        if (placeholder) placeholder.remove();

        // API Call to update backend
        fetch('/update-application-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: id, newStatus: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`âœ… Status updated successfully for ${id}:`, data);
        })
        .catch(error => {
            console.error(`âŒ Error updating status for ${id}:`, error);
        });

        console.log(`ðŸ“¦ Applicant ${id} moved to ${newStatus}`);
    });

    // Check if the original column is empty and add placeholder
    if (!sourceColumn.querySelector('.draggable-item')) {
        let newPlaceholder = document.createElement("li");
        newPlaceholder.className = "bg-gray-100 p-4 rounded-lg text-center text-gray-400 draggable-placeholder";
        newPlaceholder.textContent = "No Applicants";
        sourceColumn.appendChild(newPlaceholder);
    }

    // âœ… **Reattach checkbox event listeners IMMEDIATELY**
    attachCheckboxListeners();
}

function attachCheckboxListeners() {
    document.querySelectorAll('.applicant-checkbox').forEach(checkbox => {
        checkbox.removeEventListener("change", handleCheckboxChange); // Remove existing listeners to avoid duplication
        checkbox.addEventListener("change", handleCheckboxChange);
    });
}

function handleCheckboxChange() {
    let status = this.closest(".kanban-column").getAttribute("data-status");
    let moveButton = document.querySelector(`.kanban-column[data-status="${status}"] .move-to-next-stage`);

    if (document.querySelector(`.kanban-column[data-status="${status}"] .applicant-checkbox:checked`)) {
        moveButton.classList.remove("hidden"); // Show move button
    } else {
        moveButton.classList.add("hidden"); // Hide if nothing selected
    }
}

// **Attach Event Listeners Dynamically on Page Load**
document.addEventListener("DOMContentLoaded", () => {
    attachCheckboxListeners();

    // **Attach to Kanban Click Events (Dynamically)**
    document.getElementById("kanbanView").addEventListener("click", function(event) {
        if (event.target.matches(".applicant-checkbox")) {
            handleCheckboxChange.call(event.target);
        }
    });
});


</script>
{% endblock %}
