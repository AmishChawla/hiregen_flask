{% extends 'base.html' %}

{% block title %}Applicants{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.0.0/dist/tailwind.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>

<style>
    .draggable-item {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .draggable-item.is-dragging {
        transform: scale(1.05);
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        background-color: #e2e8f0;
    }
    .draggable-list {
        transition: background-color 0.2s ease-in-out;
    }
    .draggable-list.is-hovered {
        background-color: #edf2f7;
    }
    .kanban-column {
        min-width: 16rem;
    }
    .drawer {
        position: fixed;
        top: 0;
        right: -100%;
        width: 24rem;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 8px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease-in-out;
        z-index: 50;
        overflow-y: auto;
        border-left: 1px solid #e5e7eb;
    }
    .drawer.open {
        right: 0;
    }
    .drawer-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .drawer-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .drawer-content {
        padding: 1rem;
    }
    .drawer-content p {
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: #374151;
    }
    .drawer-content a {
        color: #3b82f6;
        text-decoration: underline;
    }
</style>

<div class="container mx-auto p-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Applicant Tracking</h1>
        <button id="toggleView" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Switch to Table View
        </button>
    </div>

    <!-- Kanban View -->
    <div id="kanbanView" class="flex space-x-4 overflow-x-auto">
        {% for status in statuses %}
        <div class="kanban-column bg-white rounded-lg shadow-md w-64 min-h-[70vh] p-4">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">{{ status.capitalize() }}</h3>
            <ul class="space-y-4 draggable-list" data-status="{{ status }}">
                {% if result | selectattr('application_status', 'equalto', status) | list | length == 0 %}
                <li class="bg-gray-100 p-4 rounded-lg text-center text-gray-400 draggable-placeholder">No Applicants</li>
                {% endif %}
                {% for data in result %}
                {% if data.application_status == status %}
                <li class="bg-gray-100 p-4 rounded-lg shadow draggable-item flex justify-between items-center" data-id="{{ data.application_id }}" data-status="{{ data.application_status }}">
                    <div class="flex items-center space-x-4">
                        <img src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/default.png') }}" class="w-10 h-10 rounded-full flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-700 font-medium truncate">{{ data.applicant_name }}</p>
                            <p class="text-sm text-gray-500 truncate">{{ data.applicant_email }}</p>
                        </div>
                    </div>
                    <button onclick="openDrawer({{ data.application_id }}, '{{ data.applicant_name }}', '{{ data.applicant_email }}', '{{ data.application_date }}', '{{ data.application_status }}', '{{ data.resume }}')" class="text-gray-500 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                        </svg>
                    </button>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div id="tableView" class="hidden">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="sm:flex sm:items-center">
                <div class="sm:flex-auto">
                    <h1 class="text-base font-semibold text-gray-900">Applicants</h1>
                    <p class="mt-2 text-sm text-gray-700">A list of all applicants including their name, email, status, and application date.</p>
                </div>
            </div>
            <div class="mt-8 flow-root">
                <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead>
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Name</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Email</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Applied On</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                {% for data in result %}
                                <tr>
                                    <td class="whitespace-nowrap py-5 pl-4 pr-3 text-sm sm:pl-0">
                                        <div class="flex items-center">
                                            <img class="w-10 h-10 rounded-full" src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/default.png') }}" alt="">
                                            <div class="ml-4">
                                                <div class="font-medium text-gray-900">{{ data.applicant_name }}</div>
                                                <div class="mt-1 text-gray-500">{{ data.applicant_email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.applicant_email }}</td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.application_status }}</td>
                                    <td class="whitespace-nowrap px-3 py-5 text-sm text-gray-500">{{ data.application_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Drawer for Applicant Details -->
<div id="applicantDrawer" class="drawer">
    <div class="p-4 drawer-header flex justify-between items-center">
        <h2 id="drawerTitle" class="drawer-title">Applicant Details</h2>
        <button onclick="closeDrawer()" class="text-gray-500">&times;</button>
    </div>
    <div class="drawer-content" id="drawerContent">
        <!-- Content dynamically populated -->
    </div>
</div>

<script>
    function openDrawer(id, name, email, date, status, resume) {
        const drawer = document.getElementById('applicantDrawer');
        const content = document.getElementById('drawerContent');
        const title = document.getElementById('drawerTitle');

        // Get the latest status from the draggable item's data-status attribute
        const item = document.querySelector(`.draggable-item[data-id='${id}']`);
        const currentStatus = item ? item.getAttribute('data-status') : status;

        title.textContent = `${name}`;
        content.innerHTML = `
            <p><strong>Email:</strong> ${email}</p>
            <p><strong>Applied On:</strong> ${date}</p>
            <p><strong>Status:</strong> ${currentStatus}</p>
            <p><strong>Resume:</strong> <a href="${resume}" class="text-blue-600" target="_blank">View Resume</a></p>
        `;

        drawer.classList.add('open');
    }

    function closeDrawer() {
        const drawer = document.getElementById('applicantDrawer');
        drawer.classList.remove('open');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const containers = Array.from(document.querySelectorAll('.draggable-list'));

        const drake = dragula(containers, {
            moves: function(el, container, handle) {
                return el.classList.contains('draggable-item'); // Allow dragging only for items with this class
            },
            accepts: function(el, target) {
                return target.classList.contains('draggable-list'); // Ensure valid drop targets
            },
            mirrorContainer: document.body // Append the drag mirror to the body for smooth dragging
        });

        drake.on('drag', function(el) {
            el.classList.add('is-dragging');
        });

        drake.on('dragend', function(el) {
            el.classList.remove('is-dragging');
        });

        drake.on('over', function(el, container) {
            container.classList.add('is-hovered');
        });

        drake.on('out', function(el, container) {
            container.classList.remove('is-hovered');
        });

        drake.on('drop', function(el, target, source) {
            if (target && target !== source) {
                const placeholder = target.querySelector('.draggable-placeholder');
                if (placeholder) placeholder.remove(); // Remove placeholder if exists in target

                if (!source.querySelector('.draggable-item')) {
                    const newPlaceholder = document.createElement('li');
                    newPlaceholder.className = 'bg-gray-100 p-4 rounded-lg text-center text-gray-400 draggable-placeholder';
                    newPlaceholder.textContent = 'No Applicants';
                    source.appendChild(newPlaceholder);
                }

                target.appendChild(el); // Append the element to the new container

                // Update the status data attribute
                const newStatus = target.dataset.status;
                el.setAttribute('data-status', newStatus);

                // Make API call to update application status
                const applicationId = el.getAttribute('data-id');

                fetch('/update-application-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: applicationId, newStatus: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Status updated successfully:', data);
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                });

                console.log(`Element ${applicationId} dropped into ${newStatus}`);
            } else {
                source.appendChild(el); // Return to the source container if invalid drop
                console.log('Invalid drop, returned to source.');
            }
        });

        drake.on('cancel', function(el) {
            el.classList.remove('is-dragging');
            console.log('Drag canceled.');
        });
    });
</script>
<script>
    function toggleView() {
        const kanbanView = document.getElementById('kanbanView');
        const tableView = document.getElementById('tableView');
        const toggleButton = document.getElementById('toggleView');

        if (kanbanView.classList.contains('hidden')) {
            kanbanView.classList.remove('hidden');
            tableView.classList.add('hidden');
            toggleButton.textContent = 'Switch to Table View';
        } else {
            kanbanView.classList.add('hidden');
            tableView.classList.remove('hidden');
            toggleButton.textContent = 'Switch to Kanban View';
        }
    }

    document.getElementById('toggleView').addEventListener('click', toggleView);
</script>


{% endblock %}
