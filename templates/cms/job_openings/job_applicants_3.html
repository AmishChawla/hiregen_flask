{% extends 'base.html' %}

{% block title %}Applicants{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.0.0/dist/tailwind.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>

<style>
    .draggable-item {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .draggable-item.is-dragging {
        transform: scale(1.05);
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        background-color: #e2e8f0;
    }
    .draggable-list {
        transition: background-color 0.2s ease-in-out;
    }
    .draggable-list.is-hovered {
        background-color: #edf2f7;
    }
    .kanban-column {
        min-width: 20rem;
    }
    .drawer {
        position: fixed;
        top: 0;
        right: -100%;
        width: 24rem;
        height: 100%;
        background: white;
        box-shadow: -2px 0px 8px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease-in-out;
        z-index: 50;
        overflow-y: auto;
        border-left: 1px solid #e5e7eb;
    }
    .drawer.open {
        right: 0;
    }
    .drawer-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }
    .drawer-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .drawer-content {
        padding: 1rem;
    }
    .drawer-content p {
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: #374151;
    }
    .drawer-content a {
        color: #3b82f6;
        text-decoration: underline;
    }
</style>

<div class="container mx-auto p-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
        <h1 class="text-2xl font-bold">Applicant Tracking</h1>
        </div>
        <div>
        <button id="convertDownloadCsvBtn" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            Download CSV
        </button>

        <button id="toggleView" class="rounded-md bg-purple-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 focus-visible:outline focus-visible:outline-1 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Switch to Table View
        </button>
        </div>
    </div>

    <!-- Kanban View -->
    <div id="kanbanView" class="flex space-x-4 overflow-x-auto">
        {% for status in statuses|sort(attribute='stage_order') %}
        <div class="kanban-column bg-white rounded-lg shadow-md w-80 min-h-[70vh] p-4" data-status="{{ status.job_status }}">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-semibold text-gray-700">{{ status.name }}</h3>
            <label class="text-xs font-medium text-slate-800 flex items-center space-x-1">
                <input type="checkbox" class="select-all-checkbox w-4 h-4 text-purple-500 border-gray-300 rounded" data-status="{{ status.job_status }}">
                <span id="select-text-{{ status.job_status }}">Select All</span>
            </label>
        </div>
                    <!-- Search and Sort Input -->
            <div class="mb-4">
                <div>
                    <div class="mt-2 flex">
                        <div class="-mr-px grid grow grid-cols-1 focus-within:relative">
                            <input type="text" name="query_{{ status.job_status }}" id="query_{{ status.job_status }}" class="col-start-1 row-start-1 block w-full rounded-l-md bg-white py-2 pl-10 pr-3 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-1 focus:-outline-offset-2 focus:outline-indigo-600 sm:pl-9 sm:text-sm/6" placeholder="Search Applicants">
                            <svg class="pointer-events-none col-start-1 row-start-1 ml-3 size-5 self-center text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
                                <path d="M8.5 4.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10.9 12.006c.11.542-.348.994-.9.994H2c-.553 0-1.01-.452-.902-.994a5.002 5.002 0 0 1 9.803 0ZM14.002 12h-1.59a2.556 2.556 0 0 0-.04-.29 6.476 6.476 0 0 0-1.167-2.603 3.002 3.002 0 0 1 3.633 1.911c.18.522-.283.982-.836.982ZM12 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" />
                            </svg>
                        </div>
                        <button type="button" data-status="{{ status.job_status }}" class="filter-button flex shrink-0 items-center gap-x-1.5 rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 hover:bg-gray-50 focus:relative focus:outline focus:outline-1 focus:-outline-offset-2 focus:outline-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 text-gray-400">
                              <path fill-rule="evenodd" d="M3.792 2.938A49.069 49.069 0 0 1 12 2.25c2.797 0 5.54.236 8.209.688a1.857 1.857 0 0 1 1.541 1.836v1.044a3 3 0 0 1-.879 2.121l-6.182 6.182a1.5 1.5 0 0 0-.439 1.061v2.927a3 3 0 0 1-1.658 2.684l-1.757.878A.75.75 0 0 1 9.75 21v-5.818a1.5 1.5 0 0 0-.44-1.06L3.13 7.938a3 3 0 0 1-.879-2.121V4.774c0-.897.64-1.683 1.542-1.836Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Filter Panel (Initially Hidden) -->
            <div class="hidden filter-dropdown bg-white rounded-lg shadow-md p-4 border border-gray-200 absolute z-50" id="filter-panel-{{ status.job_status }}">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Filter by Score</h4>

        <label class="block text-sm font-medium text-gray-900">Overall Score</label>
        <input type="number" id="min-score-{{ status.job_status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-score-{{ status.job_status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Experience</label>
        <input type="number" id="min-exp-{{ status.job_status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-exp-{{ status.job_status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Education</label>
        <input type="number" id="min-edu-{{ status.job_status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-edu-{{ status.job_status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <label class="block text-sm font-medium text-gray-900">Skills</label>
        <input type="number" id="min-skill-{{ status.job_status }}" placeholder="Min" class="block w-full p-1 mt-1 border rounded-md">
        <input type="number" id="max-skill-{{ status.job_status }}" placeholder="Max" class="block w-full p-1 mt-1 border rounded-md mb-3">

        <button type="button" class="apply-filter bg-purple-500 text-white px-3 py-2 rounded-md w-full mt-3" data-status="{{ status.job_status }}">
            Apply Filter
        </button>
    </div>
            {% if not loop.last %}
            <button id="move-btn-{{ status.job_status }}" class="hidden my-1 w-full rounded bg-purple-500 px-2 py-1 text-sm font-semibold text-white shadow-sm hover:bg-purple-500 focus-visible:outline focus-visible:outline-1 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" onclick="moveToNextStage('{{ status.job_status }}')">
                Move to Next Stage
            </button>
            {% endif %}

            <ul class="space-y-4 draggable-list w-72" data-status="{{ status.job_status }}" data-stage-id="{{status.id}}" data-stage-name="{{status.name}}">
                {% if result | selectattr('application_status', 'equalto', status.job_status) | list | length == 0 %}
                <li class="bg-gray-50 p-4 rounded-lg text-center text-gray-400 draggable-placeholder">No Applicants</li>
                {% endif %}
                {% for data in result %}
                {% if data.application_status == status.job_status %}
                <li class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow draggable-item flex justify-between items-center space-x-4"
                data-id="{{ data.application_id }}"
                data-status="{{ data.application_status }}"
                data-overall-score="{{ data.similarity_scores.overall_score }}"
                data-experience-score="{{ data.similarity_scores.experience_embedding }}"
                data-education-score="{{ data.similarity_scores.education_embedding }}"
                data-skill-score="{{ data.similarity_scores.skill_embedding }}"
                data-leadership-score="{{ data.similarity_scores.leadership_embedding }}"
                data-industry-score="{{ data.similarity_scores.industry_embedding }}">
    <!-- Left Section: Profile Picture and Info -->
    <div class="flex items-center space-x-1 overflow-hidden">
        <input type="checkbox" class="applicant-checkbox w-4 h-4 text-purple-500 border-gray-300 rounded" data-status="{{ status.job_status }}">

        <!-- Profile Picture -->
        <img src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/man.png') }}" alt="{{ data.applicant_name }}'s profile picture" class="w-12 h-12 rounded-full border border-gray-200 flex-shrink-0">

        <!-- Applicant Info -->
        <div class="flex-1 min-w-0">
            <p class="text-gray-800 font-semibold text-sm truncate" title="{{ data.applicant_name }}">{{ data.applicant_name }}</p>
            <p class="text-gray-500 text-xs truncate" title="{{ data.applicant_email }}">{{ data.applicant_email }}</p>
        </div>
    </div>

    <!-- Right Section: Similarity Score -->
    <div class="flex items-center space-x-1">
        <!-- Similarity Score -->
        <div class="bg-white text-slate-800 text-sm font-medium p-1 rounded-full text-center flex border-2 border-gray-300">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="mt-1 mr-1 size-5 text-yellow-500">
  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
</svg>
            <p class="text-lg">{{ data.similarity_scores.overall_score }}</p>
        </div>

        <button onclick="openApplicationLogModal('{{ data.application_id }}', '{{ status.id }}')" class="text-gray-500 hover:text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              </svg>
        </button>


        <!-- Action Button -->
        <button onclick="openDrawer({{ data.application_id }}, '{{ data.applicant_name }}', '{{ data.applicant_email }}', '{{ data.application_date }}', '{{ data.resume }}', '{{data.similarity_scores.overall_score}}', '{{data.similarity_scores.experience_embedding}}', '{{data.similarity_scores.education_embedding}}', '{{data.similarity_scores.skill_embedding}}', '{{data.similarity_scores.leadership_embedding}}', '{{data.similarity_scores.industry_embedding}}')" class="text-gray-500 hover:text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
        </button>
    </div>
</li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div id="tableView" class="hidden">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="sm:flex sm:items-center">
                <div class="sm:flex-auto">
                    <h1 class="text-base font-semibold text-gray-900">Applicants</h1>
                    <p class="mt-2 text-sm text-gray-700">A list of all applicants including their name, email, status, and application date.</p>
                </div>
            </div>
            <div class="flow-root">
                <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-6">
                    <div class="inline-block min-w-full align-middle">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead>
                                <tr>
                                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Name</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Email</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Applied On</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                {% for data in result %}
                                <tr>
                                    <td class="py-4 pr-3 pl-4 text-sm font-medium whitespace-nowrap text-gray-900 sm:pl-6 lg:pl-8">
                                        <div class="flex items-center">
                                            <img class="w-10 h-10 rounded-full" src="{{ data.applicant_profile_picture if data.applicant_profile_picture else url_for('static', filename='images/man.png') }}" alt="">
                                            <div class="ml-4">
                                                <div class="font-medium text-gray-900">{{ data.applicant_name }}</div>
                                                <div class="mt-1 text-gray-500">{{ data.applicant_email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dt-type-numeric">{{ data.applicant_email }}</td>
                                    <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dt-type-numeric">{{ data.application_status }}</td>
                                    <td class="px-3 py-4 text-sm whitespace-nowrap text-gray-500 dt-type-numeric">{{ data.application_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Applicant Drawer (Initially Hidden) -->
<div id="applicantDrawer" class="relative z-10 hidden" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
  <!-- Background Overlay -->
  <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

  <div class="fixed inset-0 overflow-hidden">
    <div class="absolute inset-0 overflow-hidden">
      <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
        <!-- Slide-over panel -->
        <div class="pointer-events-auto w-screen max-w-2xl transform transition ease-in-out duration-500 sm:duration-700 translate-x-full" id="drawerPanel">
          <div class="flex h-full flex-col overflow-y-scroll bg-white shadow-xl">
            <div class="flex-1">
              <!-- Header -->
              <div class="bg-white px-4 py-6 sm:px-6">
                <div class="flex items-start justify-between space-x-3">
                  <div class="px-4 sm:px-0">
                    <h3 class="text-base font-semibold text-gray-900">Applicant Information</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">Personal details and application.</p>
                  </div>
                  <div class="flex h-7 items-center">
                    <button type="button" class="relative text-gray-400 hover:text-gray-500" onclick="closeDrawer()">
                      <span class="absolute -inset-2.5"></span>
                      <span class="sr-only">Close panel</span>
                      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Applicant Information -->
              <div class="space-y-6 py-6 sm:space-y-0 sm:divide-y sm:divide-gray-200 sm:py-0 px-6" id="drawerContent">
                <div>
                  <div class="mt-6 border-t border-gray-100">
                    <dl class="divide-y divide-gray-100">
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Full name</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicantName"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Email address</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicantEmail"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Applied On</dt>
                        <dd class="mt-1 text-sm text-gray-700 sm:col-span-2 sm:mt-0" id="drawerApplicationDate"></dd>
                      </div>
                      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                        <dt class="text-sm font-medium text-gray-900">Overall Score</dt>
                        <dd class="mt-1 sm:col-span-2 sm:mt-0">
                          <!-- Gauge for Overall Score -->
                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeOverall" cx="18" cy="18" r="16" fill="none" class="stroke-current text-purple-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerOverallScore" class="text-4xl font-bold text-purple-500">0</span>
                              <span class="text-purple-500 block">Overall</span>
                            </div>
                          </div>
                        </dd>
                      </div>

                      <!-- Detailed Scores Section -->
                      <div class="px-4 py-6 sm:grid sm:grid-cols-1 gap-4 sm:px-0">
                        <h3 class="text-sm font-medium text-gray-900 mb-4">Detailed Scores</h3>
                        <div class="grid grid-cols-3 gap-4">
                          <!-- Individual Gauges -->
                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeExperience" cx="18" cy="18" r="16" fill="none" class="stroke-current text-green-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerExperienceScore" class="text-4xl font-bold text-green-600">0</span>
                              <span class="text-green-600 block">Experience</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeEducation" cx="18" cy="18" r="16" fill="none" class="stroke-current text-yellow-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerEducationScore" class="text-4xl font-bold text-yellow-500">0</span>
                              <span class="text-yellow-500 block">Education</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeSkills" cx="18" cy="18" r="16" fill="none" class="stroke-current text-red-600" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerSkillScore" class="text-4xl font-bold text-red-600">0</span>
                              <span class="text-red-600 block">Skills</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeLeadership" cx="18" cy="18" r="16" fill="none" class="stroke-current text-purple-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerLeadershipScore" class="text-4xl font-bold text-purple-500">0</span>
                              <span class="text-purple-500 block">Leadership</span>
                            </div>
                          </div>

                          <div class="relative size-40">
                            <svg class="rotate-[135deg] size-full" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="18" cy="18" r="16" fill="none" class="stroke-current text-gray-200" stroke-width="2.5" stroke-dasharray="75 100" stroke-linecap="round"></circle>
                              <circle id="drawerGaugeIndustry" cx="18" cy="18" r="16" fill="none" class="stroke-current text-orange-500" stroke-width="2.5" stroke-dasharray="0 100" stroke-linecap="round"></circle>
                            </svg>
                            <div class="absolute top-1/2 start-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                              <span id="drawerIndustryScore" class="text-4xl font-bold text-orange-500">0</span>
                              <span class="text-orange-500 block">Industry</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <!-- Close Button -->
            <div class="shrink-0 border-t border-gray-200 px-4 py-5 sm:px-6">
              <div class="flex justify-end space-x-3">
                <button type="button" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" onclick="closeDrawer()">Close</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Application Log Form -->
<!-- Application Log Drawer (Slide-over) -->
<div id="applicationLogModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-40">
  <!-- Spinner overlay -->
  <div id="logModalSpinner" style="display:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 100; display: flex; align-items: center; justify-content: center;">
    <div
    class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-e-transparent align-[-0.125em] text-blue-500 motion-reduce:animate-[spin_1.5s_linear_infinite]"
    role="status">
    <span
      class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]"
      >Loading...</span
    >
  </div>
  </div>
  <div class="fixed inset-0 overflow-hidden">
    <div class="absolute inset-0 overflow-hidden">
      <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10 sm:pl-16">
        <div class="pointer-events-auto w-screen max-w-2xl">
          <form id="applicationLogForm" class="flex h-full flex-col overflow-y-auto bg-white shadow-xl">
            <div class="flex-1 flex flex-col">
              <!-- Header -->
              <div class="bg-gray-50 px-4 py-6 sm:px-6 border-b border-gray-100">
                <div class="flex items-start justify-between space-x-3">
                  <div class="space-y-1">
                    <h2 id="drawer-title" class="text-lg font-semibold text-gray-900">Application Log</h2>
                    <p class="text-sm text-gray-500">Fill in the details for this application stage. All fields are <span class="font-medium text-gray-700">Optional</span>.</p>
                  </div>
                  <div class="flex h-7 items-center">
                    <button type="button" onclick="closeApplicationLogModal()" class="relative text-gray-400 hover:text-gray-500 focus:outline-none">
                      <span class="absolute -inset-2.5"></span>
                      <span class="sr-only">Close panel</span>
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true" class="size-6">
                        <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Form Fields -->
              <div class="flex-1 space-y-6 py-6 sm:space-y-0 sm:divide-y sm:divide-gray-200 sm:py-0">
                <!-- Responsive grid for fields -->
                <div class="space-y-4 px-4 sm:px-6">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label for="logDate" class="block text-sm font-medium text-gray-900 mb-1">
                        Date <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="date" id="logDate" name="date" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" />
                    </div>
                    <div>
                      <label for="logTime" class="block text-sm font-medium text-gray-900 mb-1">
                        Time <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="time" id="logTime" name="time" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" />
                    </div>
                    <div>
                      <label for="logPlace" class="block text-sm font-medium text-gray-900 mb-1">
                        Place <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="text" id="logPlace" name="place" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="e.g. Office, Zoom, etc." />
                    </div>
                    <div>
                      <label for="logEventLink" class="block text-sm font-medium text-gray-900 mb-1">
                        Event Link <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="url" id="logEventLink" name="event_link" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="https://..." />
                    </div>
                    <div>
                      <label for="logStatus" class="block text-sm font-medium text-gray-900 mb-1">
                        Status <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <select id="logStatus" name="status" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm">
                        <option value="in_progress" selected>In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="rescheduled">Rescheduled</option>
                      </select>
                    </div>
                    <div>
                      <label for="logDuration" class="block text-sm font-medium text-gray-900 mb-1">
                        Duration (minutes) <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="number" id="logDuration" name="duration_minutes" min="0" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="e.g. 30" />
                    </div>
                    <div>
                      <label for="logScore" class="block text-sm font-medium text-gray-900 mb-1">
                        Score <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="number" id="logScore" name="score" step="0.01" min="0" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="e.g. 85.5" />
                    </div>
                    <div>
                      <label for="logRescheduleReason" class="block text-sm font-medium text-gray-900 mb-1">
                        Reschedule Reason <span class="text-gray-400 font-normal">Optional</span>
                      </label>
                      <input type="text" id="logRescheduleReason" name="reschedule_reason" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="Reason for rescheduling" />
                    </div>
                  </div>
                  <div>
                    <label for="logNotes" class="block text-sm font-medium text-gray-900 mb-1">
                      Notes <span class="text-gray-400 font-normal">Optional</span>
                    </label>
                    <textarea id="logNotes" name="notes" rows="2" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="Notes..."></textarea>
                  </div>
                  <div>
                    <label for="logFeedback" class="block text-sm font-medium text-gray-900 mb-1">
                      Feedback <span class="text-gray-400 font-normal">Optional</span>
                    </label>
                    <textarea id="logFeedback" name="feedback" rows="2" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-purple-600 sm:text-sm" placeholder="Feedback..."></textarea>
                  </div>
                </div>
              </div>

              <!-- Action buttons -->
              <div class="shrink-0 border-t border-gray-200 px-4 py-5 sm:px-6 bg-gray-50">
                <div class="flex flex-col sm:flex-row justify-end gap-2">
                  <button type="button" onclick="closeApplicationLogModal()" class="w-full sm:w-auto px-5 py-2 rounded-md border border-gray-300 bg-white text-gray-700 font-semibold hover:bg-gray-100 transition">Cancel</button>
                  <button type="submit" class="w-full sm:w-auto px-5 py-2 rounded-md bg-purple-600 text-white font-semibold shadow hover:bg-purple-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-purple-600 transition">Save</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  function openDrawer(id, name, email, date, resume, overallScore, experienceScore, educationScore, skillScore, leadershipScore, industryScore) {
      const drawer = document.getElementById('applicantDrawer');
      const drawerPanel = document.getElementById('drawerPanel');

      // Update static content
      document.getElementById('drawerApplicantName').textContent = name;
      document.getElementById('drawerApplicantEmail').textContent = email;
      document.getElementById('drawerApplicationDate').textContent = date;

      const resumeLink = document.getElementById('drawerResumeLink');
      if (resumeLink) resumeLink.href = resume || '#';

      // Update gauges
      const updateGauge = (gaugeId, textId, score) => {
          const gauge = document.getElementById(gaugeId);
          const text = document.getElementById(textId);
          if (gauge && text) {
              text.textContent = score;
              gauge.setAttribute('stroke-dasharray', `${(score / 100) * 75} 100`);
          }
      };

      updateGauge('drawerGaugeOverall', 'drawerOverallScore', overallScore);
      updateGauge('drawerGaugeExperience', 'drawerExperienceScore', experienceScore);
      updateGauge('drawerGaugeEducation', 'drawerEducationScore', educationScore);
      updateGauge('drawerGaugeSkills', 'drawerSkillScore', skillScore);
      updateGauge('drawerGaugeLeadership', 'drawerLeadershipScore', leadershipScore);
      updateGauge('drawerGaugeIndustry', 'drawerIndustryScore', industryScore);

      // Open drawer
      drawer.classList.remove('hidden');
      setTimeout(() => {
          drawerPanel.classList.remove('translate-x-full');
      }, 10);
  }

  function closeDrawer() {
      const drawerPanel = document.getElementById('drawerPanel');
      drawerPanel.classList.add('translate-x-full');
      setTimeout(() => {
          document.getElementById('applicantDrawer').classList.add('hidden');
      }, 500);
  }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const containers = Array.from(document.querySelectorAll('.draggable-list'));

        const drake = dragula(containers, {
            moves: function(el, container, handle) {
                return el.classList.contains('draggable-item'); // Allow dragging only for items with this class
            },
            accepts: function(el, target) {
                return target.classList.contains('draggable-list'); // Ensure valid drop targets
            },
            mirrorContainer: document.body // Append the drag mirror to the body for smooth dragging
        });

        drake.on('drag', function(el) {
            el.classList.add('is-dragging');
        });

        drake.on('dragend', function(el) {
            el.classList.remove('is-dragging');
        });

        drake.on('over', function(el, container) {
            container.classList.add('is-hovered');
        });

        drake.on('out', function(el, container) {
            container.classList.remove('is-hovered');
        });

        drake.on('drop', function(el, target, source) {
            if (target && target !== source) {
                const placeholder = target.querySelector('.draggable-placeholder');
                if (placeholder) placeholder.remove(); // Remove placeholder if exists in target

                if (!source.querySelector('.draggable-item')) {
                    const newPlaceholder = document.createElement('li');
                    newPlaceholder.className = 'bg-gray-50 p-4 rounded-lg text-center text-gray-400 draggable-placeholder';
                    newPlaceholder.textContent = 'No Applicants';
                    source.appendChild(newPlaceholder);
                }

                target.appendChild(el); // Append the element to the new container

                // Update the status data attribute
                const newStatus = target.dataset.status;
                let stage_id = target.dataset.stageId;
                let stage_name = target.dataset.stageName;
                el.setAttribute('data-status', newStatus);
                console.log(stage_id);

                // Make API call to update application status
                const applicationId = el.getAttribute('data-id');

                fetch('/update-application-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: applicationId, newStatus: newStatus, stage_id: stage_id, stage_name: stage_name })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Status updated successfully:', data);
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                });

                console.log(`Element ${applicationId} dropped into ${newStatus}`);
            } else {
                source.appendChild(el); // Return to the source container if invalid drop
                console.log('Invalid drop, returned to source.');
            }
        });

        drake.on('cancel', function(el) {
            el.classList.remove('is-dragging');
            console.log('Drag canceled.');
        });
    });
</script>
<script>
    function toggleView() {
        const kanbanView = document.getElementById('kanbanView');
        const tableView = document.getElementById('tableView');
        const toggleButton = document.getElementById('toggleView');

        if (kanbanView.classList.contains('hidden')) {
            kanbanView.classList.remove('hidden');
            tableView.classList.add('hidden');
            toggleButton.textContent = 'Switch to Table View';
        } else {
            kanbanView.classList.add('hidden');
            tableView.classList.remove('hidden');
            toggleButton.textContent = 'Switch to Kanban View';
        }
    }

    document.getElementById('toggleView').addEventListener('click', toggleView);
</script>
<script>
    // Function to filter applicants based on input in the search bar
    document.querySelectorAll('input[id^="query_"]').forEach((inputField) => {
        inputField.addEventListener("input", function (e) {
            const query = e.target.value.toLowerCase(); // Get the search query
            const status = e.target.id.replace("query_", ""); // Extract the status from the input field's ID
            const kanbanColumn = document.querySelector(`ul[data-status="${status}"]`); // Find the corresponding Kanban column

            if (kanbanColumn) {
                const items = kanbanColumn.querySelectorAll("li"); // Get all applicants in the column
                let hasMatch = false;

                items.forEach((item) => {
                    const nameElement = item.querySelector("p.text-gray-800");
                    const emailElement = item.querySelector("p.text-gray-500");

                    if (!nameElement || !emailElement) return; // Skip placeholder or non-applicant items

                    const name = nameElement.textContent.toLowerCase();
                    const email = emailElement.textContent.toLowerCase();

                    if (name.includes(query) || email.includes(query)) {
                        item.style.display = ""; // Show matching applicants
                        hasMatch = true;
                    } else {
                        item.style.display = "none"; // Hide non-matching applicants
                    }
                });

                // Show placeholder text if no applicants match
                const placeholder = kanbanColumn.querySelector(".draggable-placeholder");
                if (placeholder) {
                    placeholder.style.display = hasMatch ? "none" : ""; // Toggle placeholder visibility
                }
            }
        });
    });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("✅ JavaScript Loaded");

    // Toggle filter panel
    document.querySelectorAll(".filter-button").forEach(button => {
        button.addEventListener("click", function () {
            let status = this.getAttribute("data-status");
            let filterPanel = document.getElementById(`filter-panel-${status}`);

            if (!status || !filterPanel) {
                console.error(`❌ Error: Filter panel for '${status}' not found!`);
                return;
            }

            console.log(`Toggling filter panel for: ${status}`);

            // Hide other filter panels
            document.querySelectorAll(".filter-dropdown").forEach(panel => {
                if (panel !== filterPanel) {
                    panel.classList.add("hidden");
                }
            });

            // Toggle the visibility of the filter panel
            filterPanel.classList.toggle("hidden");
        });
    });

    // Apply filter logic
    document.querySelectorAll(".apply-filter").forEach(button => {
        button.addEventListener("click", function () {
            let status = this.getAttribute("data-status");
            let filterPanel = document.getElementById(`filter-panel-${status}`);

            if (!filterPanel) {
                console.error(`❌ Error: Filter panel for '${status}' not found!`);
                return;
            }

            // Get filter values
            let minOverall = parseFloat(document.getElementById(`min-score-${status}`).value) || 0;
            let maxOverall = parseFloat(document.getElementById(`max-score-${status}`).value) || 100;

            let minExp = parseFloat(document.getElementById(`min-exp-${status}`).value) || 0;
            let maxExp = parseFloat(document.getElementById(`max-exp-${status}`).value) || 100;

            let minEdu = parseFloat(document.getElementById(`min-edu-${status}`).value) || 0;
            let maxEdu = parseFloat(document.getElementById(`max-edu-${status}`).value) || 100;

            let minSkill = parseFloat(document.getElementById(`min-skill-${status}`).value) || 0;
            let maxSkill = parseFloat(document.getElementById(`max-skill-${status}`).value) || 100;

            console.log(`🎯 Applying filter for ${status}:
            - Overall: ${minOverall} to ${maxOverall}
            - Experience: ${minExp} to ${maxExp}
            - Education: ${minEdu} to ${maxEdu}
            - Skills: ${minSkill} to ${maxSkill}`);

            // Filter applicants based on input values
            document.querySelectorAll(`.kanban-column[data-status="${status}"] .draggable-item`).forEach(item => {
                let overallScore = parseFloat(item.getAttribute("data-overall-score"));
                let experienceScore = parseFloat(item.getAttribute("data-experience-score"));
                let educationScore = parseFloat(item.getAttribute("data-education-score"));
                let skillScore = parseFloat(item.getAttribute("data-skill-score"));

                let matchesFilter =
                    overallScore >= minOverall && overallScore <= maxOverall &&
                    experienceScore >= minExp && experienceScore <= maxExp &&
                    educationScore >= minEdu && educationScore <= maxEdu &&
                    skillScore >= minSkill && skillScore <= maxSkill;

                if (matchesFilter) {
                    item.classList.remove("hidden");
                } else {
                    item.classList.add("hidden");
                }
            });

            // Hide filter panel after applying
            filterPanel.classList.add("hidden");
        });
    });

    // Close filter dropdown if clicked outside
    document.addEventListener("click", function (event) {
        document.querySelectorAll(".filter-dropdown").forEach(panel => {
            if (!panel.contains(event.target) && !event.target.closest(".filter-button")) {
                panel.classList.add("hidden");
            }
        });
    });
});
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    console.log("✅ JavaScript Loaded");

    // Select All Functionality
    document.querySelectorAll(".select-all-checkbox").forEach(selectAllCheckbox => {
        selectAllCheckbox.addEventListener("change", function () {
            let status = this.getAttribute("data-status");
            let isChecked = this.checked;
            let selectText = document.getElementById(`select-text-${status}`);
            let checkboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);

            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                checkbox.classList.toggle("bg-purple-500", isChecked);
            });

            // Update text
            selectText.textContent = isChecked ? "Selected" : "Select All";
            updateMoveButton(status);
        });
    });

    // Individual Checkbox Selection
    document.querySelectorAll(".applicant-checkbox").forEach(checkbox => {
        checkbox.addEventListener("change", function () {
            let status = this.getAttribute("data-status");
            let selectAllCheckbox = document.querySelector(`.select-all-checkbox[data-status="${status}"]`);
            let selectText = document.getElementById(`select-text-${status}`);
            let allCheckboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);
            let allChecked = Array.from(allCheckboxes).every(cb => cb.checked);

            selectAllCheckbox.checked = allChecked;
            selectText.textContent = allChecked ? "Selected" : "Select All";

            // Change checkbox color when selected
            this.classList.toggle("bg-purple-500", this.checked);
            updateMoveButton(status);
        });
    });

    // Function to show/hide "Move to Next Stage" button
    function updateMoveButton(status) {
        let checkboxes = document.querySelectorAll(`.kanban-column[data-status="${status}"] .applicant-checkbox`);
        let moveBtn = document.getElementById(`move-btn-${status}`);
        let anyChecked = Array.from(checkboxes).some(cb => cb.checked);

        if (anyChecked) {
            moveBtn.classList.remove("hidden");
        } else {
            moveBtn.classList.add("hidden");
        }
    }
});

function moveToNextStage(currentStatus) {
    let statuses = {{ statuses | tojson }};
    let sortedStatuses = [...statuses].sort((a, b) => a.stage_order - b.stage_order);
    let currentIndex = sortedStatuses.findIndex(s => s.job_status === currentStatus);
    let nextStatusObj = (currentIndex >= 0 && currentIndex < sortedStatuses.length - 1)
      ? sortedStatuses[currentIndex + 1]
      : null;
    let newStatus = nextStatusObj ? nextStatusObj.job_status : null;
    let nextStageId = nextStatusObj ? nextStatusObj.id : null;

    console.log("sortedStatuses:", sortedStatuses);
    console.log("currentIndex:", currentIndex);
    console.log("newStatus:", newStatus);
    console.log("nextStageId:", nextStageId);

    if (nextStageId === null) {
        console.log("❌ No next stage found for status:", currentStatus);
        return;
    }

    let selectedApplicants = [];
    document.querySelectorAll(`.kanban-column[data-status="${currentStatus}"] .applicant-checkbox:checked`).forEach(cb => {
        let applicantCard = cb.closest("li");
        let applicationId = applicantCard.getAttribute("data-id");
        selectedApplicants.push({ id: applicationId, element: applicantCard });
    });

    if (selectedApplicants.length === 0) {
        console.log("❌ No applicants selected.");
        return;
    }

    // Target kanban column for new status
    let targetColumn = document.querySelector(`.kanban-column[data-status="${newStatus}"] .draggable-list`);
    let sourceColumn = document.querySelector(`.kanban-column[data-status="${currentStatus}"] .draggable-list`);

    selectedApplicants.forEach(({ id, element }) => {
        // Update UI immediately
        element.setAttribute("data-status", newStatus);
        targetColumn.appendChild(element); // Move to new column

        // Remove placeholder if exists in new column
        let placeholder = targetColumn.querySelector('.draggable-placeholder');
        if (placeholder) placeholder.remove();

        // API Call to update backend
        fetch('/update-application-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: id, newStatus: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`✅ Status updated successfully for ${id}:`, data);
        })
        .catch(error => {
            console.error(`❌ Error updating status for ${id}:`, error);
        });

        console.log(`📦 Applicant ${id} moved to ${newStatus}`);
    });

    // Check if the original column is empty and add placeholder
    if (!sourceColumn.querySelector('.draggable-item')) {
        let newPlaceholder = document.createElement("li");
        newPlaceholder.className = "bg-gray-50 p-4 rounded-lg text-center text-gray-400 draggable-placeholder";
        newPlaceholder.textContent = "No Applicants";
        sourceColumn.appendChild(newPlaceholder);
    }

    // ✅ **Reattach checkbox event listeners IMMEDIATELY**
    attachCheckboxListeners();
}

function attachCheckboxListeners() {
    document.querySelectorAll('.applicant-checkbox').forEach(checkbox => {
        checkbox.removeEventListener("change", handleCheckboxChange); // Remove existing listeners to avoid duplication
        checkbox.addEventListener("change", handleCheckboxChange);
    });
}

function handleCheckboxChange() {
    let status = this.closest(".kanban-column").getAttribute("data-status");
    let moveButton = document.querySelector(`.kanban-column[data-status="${status}"] .move-to-next-stage`);

    if (document.querySelector(`.kanban-column[data-status="${status}"] .applicant-checkbox:checked`)) {
        moveButton.classList.remove("hidden"); // Show move button
    } else {
        moveButton.classList.add("hidden"); // Hide if nothing selected
    }
}

// **Attach Event Listeners Dynamically on Page Load**
document.addEventListener("DOMContentLoaded", () => {
    attachCheckboxListeners();

    // **Attach to Kanban Click Events (Dynamically)**
    document.getElementById("kanbanView").addEventListener("click", function(event) {
        if (event.target.matches(".applicant-checkbox")) {
            handleCheckboxChange.call(event.target);
        }
    });
});


</script>

<script>
document.getElementById('convertDownloadCsvBtn').addEventListener('click', function() {
    // Sample JSON data (Replace with actual JSON response from your backend)
    const jsonData = {{ result | tojson }};

    // Convert JSON to CSV
    function jsonToCsv(json) {
        const csvRows = [];
        const headers = [
            "applicant_id",
            "application_id",
            "applicant_name",
            "applicant_profile_picture",
            "applicant_email",
            "application_date",
            "application_status",
            "experience_score",
            "education_score",
            "skill_score",
            "leadership_score",
            "industry_score",
            "overall_score"
        ];
        csvRows.push(headers.join(",")); // Add header row

        json.forEach(item => {
            const similarity = item.similarity_scores || {}; // Handle missing similarity scores
            const row = [
                item.applicant_id,
                item.application_id,
                `"${item.applicant_name}"`,  // Wrap text values in quotes
                item.applicant_profile_picture || "",
                item.applicant_email,
                item.application_date,
                item.application_status,
                similarity.experience_embedding || "",
                similarity.education_embedding || "",
                similarity.skill_embedding || "",
                similarity.leadership_embedding || "",
                similarity.industry_embedding || "",
                similarity.overall_score || ""
            ];
            csvRows.push(row.join(","));
        });

        return csvRows.join("\n");
    }

    // Create CSV Blob and trigger download
    const csvData = jsonToCsv(jsonData);
    const blob = new Blob([csvData], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "job_applications.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
});
</script>

<script>
    function updateApplicationLog(logId, logData) {
        fetch(`/application-log/update/${logId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(logData)
        })
    }
</script>

<script>
    function openApplicationLogModal(applicationId, stageId) {
      // Show the drawer
      document.getElementById('applicationLogModal').classList.remove('hidden');
      // Show spinner, hide form
      document.getElementById('logModalSpinner').style.display = 'flex';
      document.getElementById('applicationLogForm').style.visibility = 'hidden';
    
      fetch('/application-log/by-application-and-stage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ job_application_id: applicationId, stage_id: stageId })
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('logModalSpinner').style.display = 'none';
        document.getElementById('applicationLogForm').style.visibility = 'visible';
        // Prefill all fields
        window.currentLogId = data.log.id;
        document.getElementById('logDate').value = data.log.event_date || '';
        document.getElementById('logTime').value = data.log.event_time || '';
        document.getElementById('logPlace').value = data.log.place || '';
        document.getElementById('logEventLink').value = data.log.event_link || '';
        document.getElementById('logStatus').value = data.log.status || 'scheduled';
        document.getElementById('logNotes').value = data.log.notes || '';
        document.getElementById('logFeedback').value = data.log.feedback || '';
        document.getElementById('logRescheduleReason').value = data.log.reschedule_reason || '';
        document.getElementById('logDuration').value = data.log.duration_minutes || '';
        document.getElementById('logScore').value = data.log.score || '';      })
      .catch(error => {
        document.getElementById('logModalSpinner').style.display = 'none';
        document.getElementById('applicationLogForm').style.visibility = 'visible';
        // Prefill with empty/default values
        document.getElementById('logDate').value = '';
        document.getElementById('logTime').value = '';
        document.getElementById('logPlace').value = '';
        document.getElementById('logEventLink').value = '';
        document.getElementById('logStatus').value = 'scheduled';
        document.getElementById('logNotes').value = '';
        document.getElementById('logFeedback').value = '';
        document.getElementById('logRescheduleReason').value = '';
        document.getElementById('logDuration').value = '';
        document.getElementById('logScore').value = '';
        console.error('Error:', error);
      });
    }
    
    function closeApplicationLogModal() {
      document.getElementById('applicationLogModal').classList.add('hidden');
    }
    </script>

    <script>
        document.getElementById('applicationLogForm').addEventListener('submit', function(e) {
  e.preventDefault();

  // Collect form data
  const form = e.target;
  const logData = {
    event_date: form.date.value || null,
    event_time: form.time.value || null,
    place: form.place.value || null,
    event_link: form.event_link.value || null,
    status: form.status.value,
    notes: form.notes.value || null,
    feedback: form.feedback.value || null,
    reschedule_reason: form.reschedule_reason.value || null,
    duration_minutes: form.duration_minutes.value ? parseInt(form.duration_minutes.value) : null,
    score: form.score.value ? parseFloat(form.score.value) : null
  };

  console.log('event_date:', logData.event_date, 'type:', typeof logData.event_date);
  console.log('event_time:', logData.event_time, 'type:', typeof logData.event_time);
  console.log('place:', logData.place, 'type:', typeof logData.place);
  console.log('event_link:', logData.event_link, 'type:', typeof logData.event_link);
  console.log('status:', logData.status, 'type:', typeof logData.status);
  console.log('notes:', logData.notes, 'type:', typeof logData.notes);
  console.log('feedback:', logData.feedback, 'type:', typeof logData.feedback);
  console.log('reschedule_reason:', logData.reschedule_reason, 'type:', typeof logData.reschedule_reason);



  if (!window.currentLogId) {
    alert('No log ID found. Cannot update log.');
    return;
  }

  // Show spinner while saving
  document.getElementById('logModalSpinner').style.display = 'flex';
  document.getElementById('applicationLogForm').style.visibility = 'hidden';

  fetch(`/application-log/update/${window.currentLogId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(logData)
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('logModalSpinner').style.display = 'none';
    document.getElementById('applicationLogForm').style.visibility = 'visible';
    alert('Log saved successfully!');
    closeApplicationLogModal();
  })
  .catch(error => {
    document.getElementById('logModalSpinner').style.display = 'none';
    document.getElementById('applicationLogForm').style.visibility = 'visible';
    alert('Error saving log.');
    console.error('Error:', error);
  });
});
    </script>


{% endblock %}
