{% extends 'base.html' %}

{% block title %}Applicants{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" rel="stylesheet">

<style>
.kanban-columns-container {
  display: flex;
  gap: 10px;
}
.horizontal-scroll-container {
  position: relative;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  max-width: 100%;
  padding-right: 15px;
}
.horizontal-scroll-container::-webkit-scrollbar {
  display: none;
}
.horizontal-scroll-container > * {
  display: inline-block;
  vertical-align: middle;
}
.kanban-column {
  display: inline-block;
  vertical-align: top;
  min-height: 70vh;
  width: 12vw;
  border: 2px solid #ddd;
  border-radius: 5px;
  margin-right: 20px;
  position: relative;
  box-sizing: border-box;
}
.kanban-column::after {
  content: '';
  position: absolute;
  top: -5px;
  left: 0;
  right: 0;
  height: 10px;
  background-color: #125B9A;
  border-radius: 75%;
  z-index: 2;
}
.kanban-column h3 {
  color: #0e0f2e;
  margin-bottom: 10px;
}
.list-group-item {
  padding: 10px;
  border-radius: 5px;
}
.list-group-item:hover {
  background-color: #f5f5f5;
}
.draggable-list {
  list-style-type: none;
  padding: 0;
  min-height: 70vh;
}
.draggable-item {
  border-radius: 5px;
  cursor: move;
}
.applicant-image {
  width: 25px;
  height: 25px;
  margin-right: 10px;
  border-radius: 50%;
}
</style>

<div class="container mx-auto p-4">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold">Applicant Tracking</h2>
    <div class="flex gap-4">
      <button id="toggleKanban" class="text-blue-600"><i class="bi bi-kanban"></i></button>
      <button id="toggleTable" class="text-blue-600"><i class="bi bi-table"></i></button>
    </div>
  </div>

  <!-- Horizontal scroll container -->
  <div id="kanbanView" class="horizontal-scroll-container">
    {% for status in statuses %}
    <div class="kanban-column bg-white shadow rounded p-4">
      <h3 class="font-bold text-gray-700">{{ status.name.capitalize() }}</h3>
      <ul class="draggable-list">
        {% for data in result %}
        {% if data.application_status == status.job_status %}
        <li class="list-group-item draggable-item" data-id="{{ data.application_id }}">
          <div class="flex items-center">
            <img class="applicant-image" src="{{ data.applicant_profile_picture or url_for('static', filename='images/man.png') }}">
            <a href="{{ url_for('employer_view_jobseeker_profile', jobseeker_id=data.applicant_id) }}" class="text-blue-600">{{ data.applicant_name }}</a>
          </div>
        </li>
        {% endif %}
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>

  <div id="tableView" class="hidden mt-6">
    <table id="applicantTable" class="min-w-full border border-gray-300">
      <thead>
        <tr class="bg-gray-100">
          <th class="p-2">Name</th>
          <th class="p-2">Email</th>
          <th class="p-2">Date</th>
          <th class="p-2">Status</th>
          <th class="p-2">Resume</th>
        </tr>
      </thead>
      <tbody>
        {% for data in result %}
        <tr>
          <td class="p-2 flex items-center">
            <img class="applicant-image" src="{{ data.applicant_profile_picture or url_for('static', filename='images/man.png') }}">
            <a href="{{ url_for('employer_view_jobseeker_profile', jobseeker_id=data.applicant_id) }}" class="text-blue-600">{{ data.applicant_name }}</a>
          </td>
          <td class="p-2">{{ data.applicant_email }}</td>
          <td class="p-2">{{ data.application_date }}</td>
          <td class="p-2">{{ data.application_status.capitalize() }}</td>
          <td class="p-2"><a href="{{ data.resume }}" class="text-blue-600">View</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{url_for('static', filename='js/drag_drop.js')}}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js"></script>
<script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
<script>
new DataTable('#applicantTable');

function viewApplicantDetails(application_id, name, status, email, applicationDate, resume) {
    const offCanvas = document.getElementById('offcanvasRight');
    const offCanvasContent = offCanvas.querySelector('.offcanvas-body');
    offCanvasContent.innerHTML =
      <h5 class="offcanvas-title lead py-3">${name.charAt(0).toUpperCase() + name.slice(1)} (${status.charAt(0).toUpperCase() + status.slice(1)})</h5>
      <div class="row mb-1">
      <div class="col-4" style="font-size:0.9rem;">Email:</div> <div class="col" style="font-size:0.9rem;">${email}</div>
      </div>
      <div class="row mb-1">
      <div class="col-4" style="font-size:0.9rem;">Applied On:</div> <div class="col" style="font-size:0.9rem;">${applicationDate}</div>
      </div>
      <div class="row mb-3">
      <div class="col-4" style="font-size:0.9rem;">Resume</div> <a href="${resume}" class="text-link col" style="font-size:0.9rem;">View</a>
      </div>

      <div class="mb-3">
        <strong for="status-select" class="mb-3" style="font-size:0.9rem;">Change Status</strong>
        <select class="form-select" id="status-select" aria-label="Change Status" onchange="updateApplicationStatus('${application_id}')">
          {% for s in statuses %}
              <option value="{{ s.job_status }}" ${status === '{{ s.job_status }}' ? 'selected' : ''} >{{ s.name.capitalize() }}</option>
          {% endfor %}
        </select>
      </div>

    ;
    const offcanvasInstance = new bootstrap.Offcanvas(offCanvas);
    offcanvasInstance.show();
 }

function updateApplicationStatus(application_id) {
    const newStatus = document.getElementById('status-select').value;
    fetch(/update-application-status, {
      method: 'POST',
      body: JSON.stringify({ id: application_id, newStatus: newStatus }),
      headers: { 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(data => {
      console.log('Status updated:', data);
      window.location.reload(); // Reload the page after updating the status
    })
    .catch(error => console.error('Error updating status:', error));
 }

document.addEventListener('DOMContentLoaded', function () {
  const kanbanView = document.getElementById('kanbanView');
  const tableView = document.getElementById('tableView');
  const toggleKanban = document.getElementById('toggleKanban');
  const toggleTable = document.getElementById('toggleTable');

  kanbanView.style.display = 'block';
  tableView.style.display = 'none';

  toggleKanban.addEventListener('click', function () {
    kanbanView.style.display = 'block';
    tableView.style.display = 'none';
  });

  toggleTable.addEventListener('click', function () {
    tableView.style.display = 'block';
    kanbanView.style.display = 'none';
  });
});
</script>
{% endblock %}
