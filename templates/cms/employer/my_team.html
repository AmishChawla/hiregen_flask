{% extends 'base.html' %}

{% block title %}
My Team
{% endblock %}

{% block content %}
<main class="bg-white">
  <div class="py-6 px-4 sm:px-6 lg:px-8">
    <!-- Outer container with full screen height -->
    <div class="min-h-screen flex flex-col">
      <div class="containerr mxauto px-4 sm:px-6 lg:px-0 flex-grow">
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">My Team</h1>
        <p class="text-gray-400 mb-4">Manage your team members and their permissions</p>

        <!-- Flexbox container for the two columns with full height -->
        <div class="flex h-full space-x-4">
          <!-- First column (1/3 of the screen) -->
          <div class="mt-1 w-2/3 min-h-[60vh] bg-white pt-0 rounded-lg">
            <!-- Header with Search, + icon button, and Import CSV icon button -->
            <div class="mt-2 flex">
                <div class="-mr-px grid grow grid-cols-1 focus-within:relative">
                    <input type="text" name="query_applied" id="query_applied" class="col-start-1 row-start-1 block w-full rounded-l-md bg-white py-1.5 pl-10 pr-3 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-1 focus:-outline-offset-2 focus:outline-blue-600 sm:pl-9 sm:text-sm/6" placeholder="Search Team Members">
                    <svg class="pointer-events-none col-start-1 row-start-1 ml-3 size-5 self-center text-gray-400 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true" data-slot="icon">
                        <path d="M8.5 4.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10.9 12.006c.11.542-.348.994-.9.994H2c-.553 0-1.01-.452-.902-.994a5.002 5.002 0 0 1 9.803 0ZM14.002 12h-1.59a2.556 2.556 0 0 0-.04-.29 6.476 6.476 0 0 0-1.167-2.603 3.002 3.002 0 0 1 3.633 1.911c.18.522-.283.982-.836.982ZM12 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"></path>
                    </svg>
                </div>
                <span class="isolate inline-flex rounded-md shadow-sm">
                    <button type="button" id="open-modal-btn" class="relative inline-flex items-center bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                          
                    </button>
                    <button type="button" class="relative -ml-px inline-flex items-center rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15M9 12l3 3m0 0 3-3m-3 3V2.25" />
                        </svg>
                          
                    </button>
                </span>
                  
            </div>

            <ul role="list" class="divide-y divide-gray-100" id="team-member-list">
                {% for member in team_members %}
                <li class="group relative flex gap-x-4 px-5 py-5 cursor-pointer hover:bg-gray-50 rounded-md justify-between" data-id="{{ member.id }}">
                  <div class="flex">
                    <img class="size-12 flex-none rounded-full bg-gray-50 mr-1" src="{{ member.profile_picture or url_for('static', filename='images/man.png') }}" alt="">
                  <div class="min-w-0">
                    <p class="text-sm/6 font-semibold text-gray-900">{{ member.username }}</p>
                    <p class="truncate text-xs/5 text-gray-500">{{ member.email }}</p>
                  </div>
                </div>
                  <span class="inline-flex items-center gap-x-1.5 rounded-full px-2 py-1 text-xs font-medium text-gray-900 ring-1 ring-inset ring-gray-200">
                    <svg class="size-1.5 fill-blue-500" viewBox="0 0 6 6" aria-hidden="true">
                      <circle cx="3" cy="3" r="3" />
                    </svg>
                    {{ member.permissions.items() | selectattr('1') | list | length }} permissions
                  </span>                  
                  <button class="edit-permissions-btn mt-1 mr-1 p-1 text-black z-10" title="Edit Permissions"
                  data-member='{{ {
                    "id": member.id,
                    "permissions": {
                      "can_manage_jobs": member.permissions.can_manage_jobs,
                      "can_view_analytics": member.permissions.can_view_analytics,
                      "can_track_applicants": member.permissions.can_track_applicants,
                      "can_manage_company": member.permissions.can_manage_company,
                      "can_manage_team": member.permissions.can_manage_team
                    }
                  } | tojson }}'>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                  </svg>
              </button>
                </li>
                {% endfor %}
              </ul> 
          </div>

          <!-- Second column (2/3 of the screen) with empty state -->
          <div class="mt-2 w-1/3 min-h-[60vh] bg-white p-4 rounded-lg border-gray-300 border" id="member-permissions">
            <div class="text-center text-gray-500 mt-8">
              <p>Select Member</p>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</main>

<div id="add-member-modal" class="relative z-10 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
<div class="relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
  
    <!-- Modal container -->
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
          <div>
            <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-purple-100">
              <svg class="size-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-5">
              <h3 class="text-base font-semibold text-gray-900" id="modal-title">Add New Member</h3>
            </div>
          </div>
  
          <form action="{{ url_for('my_team') }}" method="POST" class="mt-5 space-y-4">
            <!-- First Name -->
            <div>
              <label for="first-name" class="block text-sm/6 font-medium text-gray-900">First Name</label>
              <div class="mt-2">
                <input type="text" name="first-name" id="first-name" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-600 sm:text-sm/6" placeholder="John">
              </div>
            </div>
          
            <!-- Last Name -->
            <div>
              <label for="last-name" class="block text-sm/6 font-medium text-gray-900">Last Name</label>
              <div class="mt-2">
                <input type="text" name="last-name" id="last-name" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-600 sm:text-sm/6" placeholder="Smith">
              </div>
            </div>
          
            <!-- Email -->
            <div>
              <label for="email" class="block text-sm/6 font-medium text-gray-900">Email</label>
              <div class="mt-2">
                <input type="email" name="email" id="email" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-600 sm:text-sm/6" placeholder="you@example.com">
              </div>
            </div>
          
            <!-- Password -->
            <div>
              <label for="password" class="block text-sm/6 font-medium text-gray-900">Password</label>
              <div class="mt-2">
                <input type="password" name="password" id="password" class="block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-blue-600 sm:text-sm/6" placeholder="••••••••">
              </div>
            </div>
          
            <!-- Permissions -->
            <div class="space-y-2 pt-2">
              <p class="text-sm font-medium text-gray-900">Permissions</p>
          
              <!-- Permission Toggles -->
              {% for perm in [
                ("can_manage_jobs", "Can Manage Jobs"),
                ("can_view_analytics", "Can View Analytics"),
                ("can_track_applicants", "Can Track Applicants"),
                ("can_manage_company", "Can Manage Company"),
                ("can_manage_team", "Can Manage Team")
              ] %}
              <div class="flex items-center justify-between">
                <label for="{{ perm[0] }}" class="text-sm text-gray-700">{{ perm[1] }}</label>
                <label class="inline-flex relative items-center cursor-pointer">
                  <input type="checkbox" name="{{ perm[0] }}" id="{{ perm[0] }}" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer dark:bg-gray-300 peer-checked:bg-purple-500 after:content-[''] after:absolute after:left-[2px] after:top-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                </label>
              </div>
              {% endfor %}
            </div>  
          <!-- Action Buttons -->
          <div class="mt-6 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
            <button type="submit" class="inline-flex w-full justify-center rounded-md bg-purple-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:col-start-2">Submit</button>
            <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancel</button>
          </div>
        </form>

        </div>
      </div>
    </div>
  </div>
</div>


<div id="edit-permissions-modal" class="relative z-10 hidden" aria-labelledby="edit-permissions-title" role="dialog" aria-modal="true">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
  
    <!-- Modal container -->
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md sm:p-6">
          <div>
            <div class="mx-auto flex size-12 items-center justify-center rounded-full bg-yellow-100">
              <svg class="size-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-5">
              <h3 class="text-base font-semibold text-gray-900" id="edit-permissions-title">Edit Permissions</h3>
            </div>
          </div>
  
          <form id="edit-permissions-form" action="{{url_for('update_permissions')}}" method="POST" class="mt-5 space-y-4">
            <!-- Dynamic User ID for reference -->
            <input type="hidden" name="user_id" id="edit-user-id" />
  
            <div class="space-y-2 pt-2">
              <p class="text-sm font-medium text-gray-900">Permissions</p>
  
              <!-- Permission Toggles -->
              {% for perm in [
                ("can_manage_jobs", "Can Manage Jobs"),
                ("can_view_analytics", "Can View Analytics"),
                ("can_track_applicants", "Can Track Applicants"),
                ("can_manage_company", "Can Manage Company"),
                ("can_manage_team", "Can Manage Team")
              ] %}
              <div class="flex items-center justify-between">
                <label for="edit-{{ perm[0] }}" class="text-sm text-gray-700">{{ perm[1] }}</label>
                <label class="inline-flex relative items-center cursor-pointer">
                  <input type="checkbox" name="{{ perm[0] }}" id="edit-{{ perm[0] }}" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer dark:bg-gray-300 peer-checked:bg-purple-500 after:content-[''] after:absolute after:left-[2px] after:top-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                </label>
              </div>
              {% endfor %}
            </div>
  
            <!-- Action Buttons -->
            <div class="mt-6 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
              <button type="submit" class="inline-flex w-full justify-center rounded-md bg-purple-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 sm:col-start-2">Update</button>
              <button type="button" id="cancel-edit-permissions" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancel</button>
            </div>
          </form>
  
        </div>
      </div>
    </div>
  </div>
  


<script>
    document.addEventListener("DOMContentLoaded", function () {
      const openModalBtn = document.getElementById("open-modal-btn");
      const modal = document.getElementById("add-member-modal");
      const cancelBtn = modal.querySelector("button[type='button']:not(#open-modal-btn)");
  
      openModalBtn.addEventListener("click", () => {
        modal.classList.remove("hidden");
      });
  
      cancelBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
      });
    });
  </script>
  
  <script>
    const teamMembers = {{ team_members|tojson }};
  </script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
      const teamMemberList = document.getElementById("team-member-list");
      const permissionsContainer = document.getElementById("member-permissions");
  
      teamMemberList.addEventListener("click", function (e) {
        const item = e.target.closest("li[data-id]");
        if (!item) return;
  
        const memberId = parseInt(item.dataset.id);
        const member = teamMembers.find(m => m.id === memberId);
        if (!member) return;
  
        const perms = member.permissions;
        const memberData = {
          id: member.id,
          permissions: {
            can_manage_jobs: perms.can_manage_jobs,
            can_view_analytics: perms.can_view_analytics,
            can_track_applicants: perms.can_track_applicants,
            can_manage_company: perms.can_manage_company,
            can_manage_team: perms.can_manage_team
          }
        };


        let html = `
  <div class="relative group p-4 shadow-sm bg-white">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">
      Manage ${member.username}
    </h2>

    <table class="w-full text-sm text-left">
      <thead class="text-xs text-gray-700 uppercase border-b">
        <tr>
          <th class="py-2">Permission</th>
          <th class="py-2 text-center">Status</th>
        </tr>
      </thead>
      <tbody>`;

for (const [key, value] of Object.entries(perms)) {
  const label = key
    .replace(/_/g, ' ')
    .replace(/\b\w/g, char => char.toUpperCase());

  const icon = value
    ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-green-500">
         <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
       </svg>`
    : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-500">
         <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
       </svg>`;

  const text = value 
    ? '<span class="text-green-600 font-semibold">Yes</span>' 
    : '<span class="text-red-600 font-semibold">No</span>';

  html += `
        <tr class="border-b">
          <td class="py-2">${label}</td>
          <td class="py-2 text-center">
            <div class="flex items-center justify-center gap-2">
              ${icon}
              ${text}
            </div>
          </td>
        </tr>`;
}

html += `
      </tbody>
    </table>

    <div class="flex justify-between mt-4">
      <button class="edit-permissions-btn w-full px-1 py-2 border rounded hover:bg-gray-100 font-bold text-xs" data-member='${JSON.stringify(memberData)}'>Edit Permissions</button>
    </div>
  </div>`;

permissionsContainer.innerHTML = html;

      });
    });
  </script>
    

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.getElementById('edit-permissions-modal');
      
        // 1. Delegated click handler for ALL .edit-permissions-btn buttons
        document.addEventListener('click', function (e) {
          const button = e.target.closest('.edit-permissions-btn');
          if (!button) return;
      
          e.stopPropagation();
      
          // Get member data from data attribute
          const memberData = JSON.parse(button.dataset.member);
          if (!memberData || !memberData.permissions) return;
      
          // Populate user ID
          document.getElementById('edit-user-id').value = memberData.id;
      
          // Set checkbox states based on permissions
          for (const key in memberData.permissions) {
            const checkbox = document.getElementById(`edit-${key}`);
            if (checkbox) checkbox.checked = memberData.permissions[key];
          }
      
          // Show the modal
          editModal.classList.remove('hidden');
        });
      
        // 2. Cancel button inside modal
        const cancelButton = document.getElementById('cancel-edit-permissions');
        if (cancelButton) {
          cancelButton.addEventListener('click', function () {
            editModal.classList.add('hidden');
          });
        }
      
        // 3. Optional: clicking outside the modal closes it
        editModal.addEventListener('click', function (e) {
          if (e.target === editModal) {
            editModal.classList.add('hidden');
          }
        });
      });
      </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("query_applied");
    const memberList = document.getElementById("team-member-list");
    const members = memberList.querySelectorAll("li");

    searchInput.addEventListener("input", function () {
      const query = this.value.trim().toLowerCase();

      members.forEach(member => {
        const name = member.querySelector("p.font-semibold").textContent.toLowerCase();
        const email = member.querySelector("p.text-gray-500").textContent.toLowerCase();
        
        const isMatch = name.includes(query) || email.includes(query);
        member.style.display = isMatch ? "flex" : "none";
      });
    });
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const firstMember = document.querySelector("#team-member-list li");
    if (firstMember) {
      firstMember.click();
    }
  });
</script>

                    
{% endblock %}
